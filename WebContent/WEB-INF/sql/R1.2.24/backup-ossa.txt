-- MySQL dump 10.13  Distrib 5.6.20, for Win64 (x86_64)
--
-- Host: localhost    Database: ossa
-- ------------------------------------------------------
-- Server version	5.6.20

/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!40101 SET NAMES utf8 */;
/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;
/*!40103 SET TIME_ZONE='+00:00' */;
/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;

--
-- Table structure for table `tarea`
--

DROP TABLE IF EXISTS `tarea`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tarea` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cKey` varchar(10) NOT NULL DEFAULT '',
  `cName` varchar(50) NOT NULL,
  `cCostCenter` varchar(10) NOT NULL,
  `cParent` bigint(20) DEFAULT NULL,
  PRIMARY KEY (`cId`),
  UNIQUE KEY `cKey` (`cKey`),
  KEY `area_index_area` (`cParent`),
  CONSTRAINT `AreaToArea` FOREIGN KEY (`cParent`) REFERENCES `tarea` (`cId`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `tarea`
--

LOCK TABLES `tarea` WRITE;
/*!40000 ALTER TABLE `tarea` DISABLE KEYS */;
INSERT INTO `tarea` VALUES (1,'EMP','Empresa','EMP',NULL);
/*!40000 ALTER TABLE `tarea` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `tattendancelog`
--

DROP TABLE IF EXISTS `tattendancelog`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tattendancelog` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cEmployeeKey` varchar(15) DEFAULT NULL,
  `cMachine` bigint(20) NOT NULL,
  `cDate` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `cMarkType` bigint(20) NOT NULL,
  PRIMARY KEY (`cId`),
  KEY `AttendanceLog_index_Machine` (`cMachine`),
  KEY `AttendanceLog_index_FastSearch` (`cEmployeeKey`,`cDate`,`cMarkType`),
  KEY `AttendanceLog_index_MarkType` (`cMarkType`),
  CONSTRAINT `AttendanceLog_To_Machine` FOREIGN KEY (`cMachine`) REFERENCES `tmachine` (`cId`),
  CONSTRAINT `AttendanceLog_To_MarkType` FOREIGN KEY (`cMarkType`) REFERENCES `tmarktype` (`cId`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `tattendancelog`
--

LOCK TABLES `tattendancelog` WRITE;
/*!40000 ALTER TABLE `tattendancelog` DISABLE KEYS */;
/*!40000 ALTER TABLE `tattendancelog` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `tattendancemodify`
--

DROP TABLE IF EXISTS `tattendancemodify`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tattendancemodify` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cWho` bigint(20) NOT NULL,
  `cWhen` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `cEmployee` bigint(20) NOT NULL,
  `cAttendanceLog` bigint(20) DEFAULT NULL COMMENT 'Apply only when is modify, else is null',
  `cOldMachine` bigint(20) DEFAULT NULL,
  `cNewMachine` bigint(20) NOT NULL,
  `cOldDate` timestamp NULL DEFAULT NULL,
  `cNewDate` timestamp NOT NULL DEFAULT '0000-00-00 00:00:00',
  `cOldMarkType` bigint(20) DEFAULT NULL,
  `cNewMarkType` bigint(20) NOT NULL,
  PRIMARY KEY (`cId`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `tattendancemodify`
--

LOCK TABLES `tattendancemodify` WRITE;
/*!40000 ALTER TABLE `tattendancemodify` DISABLE KEYS */;
/*!40000 ALTER TABLE `tattendancemodify` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `tcrewprocess`
--

DROP TABLE IF EXISTS `tcrewprocess`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tcrewprocess` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cDate` date NOT NULL,
  `cEmployee` bigint(20) NOT NULL,
  `cHoursWorked` double DEFAULT '0' COMMENT 'Indica cuantas horas trabajo',
  `cWorked` bit(1) DEFAULT b'0' COMMENT 'Indica que la persona fue o no a trabajar',
  `cHired` bit(1) DEFAULT b'0' COMMENT 'Indica que la persona tiene turno de trabajo ese día.',
  PRIMARY KEY (`cId`),
  KEY `CrewProcess_index_Employee` (`cEmployee`),
  CONSTRAINT `CrewProcess_To_Employee` FOREIGN KEY (`cEmployee`) REFERENCES `temployee` (`cId`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `tcrewprocess`
--

LOCK TABLES `tcrewprocess` WRITE;
/*!40000 ALTER TABLE `tcrewprocess` DISABLE KEYS */;
/*!40000 ALTER TABLE `tcrewprocess` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `tdatatype`
--

DROP TABLE IF EXISTS `tdatatype`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tdatatype` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cKey` varchar(10) NOT NULL,
  `cName` varchar(20) NOT NULL,
  PRIMARY KEY (`cId`),
  UNIQUE KEY `cId` (`cId`),
  UNIQUE KEY `cKey` (`cKey`)
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `tdatatype`
--

LOCK TABLES `tdatatype` WRITE;
/*!40000 ALTER TABLE `tdatatype` DISABLE KEYS */;
INSERT INTO `tdatatype` VALUES (1,'STRING','String'),(2,'DOUBLE','Double'),(3,'INTEGER','Integer'),(4,'TIMESTAMP','Timestamp'),(5,'BOOLEAN','Boolean'),(6,'LONG','Long');
/*!40000 ALTER TABLE `tdatatype` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `temployee`
--

DROP TABLE IF EXISTS `temployee`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `temployee` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cKey` varchar(25) NOT NULL,
  `cRut` varchar(11) DEFAULT NULL COMMENT 'Rut',
  `cName` varchar(50) NOT NULL COMMENT 'Nombre',
  `cPost` bigint(20) DEFAULT NULL COMMENT 'Codigo Cargo',
  `cArea` bigint(20) DEFAULT NULL COMMENT 'Codigo Area',
  `cPrivilege` bigint(20) DEFAULT '1',
  `cEnabled` bit(1) NOT NULL DEFAULT b'1',
  `cGroup` bigint(20) NOT NULL,
  `cUsername` varchar(40) DEFAULT NULL,
  `cMail` varchar(50) DEFAULT NULL,
  `cBoss` bigint(20) DEFAULT NULL,
  PRIMARY KEY (`cId`),
  UNIQUE KEY `cKey` (`cKey`),
  KEY `Employee_index_Post` (`cPost`),
  KEY `Employee_index_Area` (`cArea`),
  KEY `Employee_index_Privilege` (`cPrivilege`),
  KEY `employee_index_group` (`cGroup`),
  KEY `employee_index_employee` (`cBoss`),
  CONSTRAINT `EmployeeToArea` FOREIGN KEY (`cArea`) REFERENCES `tarea` (`cId`),
  CONSTRAINT `EmployeeToEmployee` FOREIGN KEY (`cBoss`) REFERENCES `temployee` (`cId`),
  CONSTRAINT `EmployeeToGroup` FOREIGN KEY (`cGroup`) REFERENCES `tgroup` (`cId`),
  CONSTRAINT `EmployeeToPost` FOREIGN KEY (`cPost`) REFERENCES `tpost` (`cId`),
  CONSTRAINT `EmployeeToPrivilege` FOREIGN KEY (`cPrivilege`) REFERENCES `tprivilege` (`cId`)
) ENGINE=InnoDB AUTO_INCREMENT=14 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `temployee`
--

LOCK TABLES `temployee` WRITE;
/*!40000 ALTER TABLE `temployee` DISABLE KEYS */;
INSERT INTO `temployee` VALUES (1,'1','1-9','Administrador',1,1,4,'',1,'',NULL,NULL),(2,'2','2-1','Luis Rojas',1,1,1,'',1,'lrojas',NULL,1),(3,'3','3-1','Manuel Hernandez',1,1,1,'',1,'mhernandez',NULL,1),(4,'4','4-1','Ricardo Guardamagn',1,1,2,'',1,'rguardamagn',NULL,1),(5,'5','5-8','Juan Perez',1,1,2,'',1,'jperez',NULL,1),(6,'6','6-1','Manuel Muñoz',1,1,1,'',2,'mmunoz',NULL,1),(7,'7','7-1','Ramon Nuñez',1,1,1,'',1,'rnunez',NULL,1),(8,'8','8-1','Roman Moscoso',1,1,1,'',1,'rmoscoso',NULL,1),(9,'9','9-1','Daniel Gonzalez',1,1,1,'',1,'dgonzalez',NULL,1),(10,'10','10-1','Roberto Rojas',1,1,1,'',1,'rrojas',NULL,1),(11,'162','11-1','ACOSTA FICA CAROLINA DEL',1,1,1,'',2,'cacosta',NULL,NULL),(12,'381','12-1','ACUÑA PEREZ PAOLA',1,1,1,'',2,'pacuna',NULL,NULL),(13,'609','13-1','ACUÑA CARREÑO JORGE MAUR',1,1,1,'',2,'jacuna',NULL,1);
/*!40000 ALTER TABLE `temployee` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `tevent`
--

DROP TABLE IF EXISTS `tevent`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tevent` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cEventType` bigint(20) NOT NULL,
  `cWhen` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `cUser` bigint(20) NOT NULL,
  `cWhat` text NOT NULL,
  PRIMARY KEY (`cId`),
  KEY `event_index_eventType` (`cEventType`),
  CONSTRAINT `event_to_eventType` FOREIGN KEY (`cEventType`) REFERENCES `teventtype` (`cId`)
) ENGINE=InnoDB AUTO_INCREMENT=37 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `tevent`
--

LOCK TABLES `tevent` WRITE;
/*!40000 ALTER TABLE `tevent` DISABLE KEYS */;
INSERT INTO `tevent` VALUES (1,3,'2016-01-29 01:47:17',4,'Salida del sistema'),(2,4,'2016-01-29 01:47:37',4,'Usuario no tiene roles configurados'),(3,3,'2016-01-29 01:48:16',1,'Salida del sistema'),(4,1,'2016-01-29 01:48:22',4,'Acceso correcto al sistema, Rol/es: Administrador.'),(5,1,'2016-01-29 02:24:56',4,'Acceso correcto al sistema, Rol/es: Administrador.'),(6,1,'2016-01-29 02:28:37',4,'Acceso correcto al sistema, Rol/es: Administrador.'),(7,1,'2016-01-29 02:40:06',4,'Acceso correcto al sistema, Rol/es: Administrador.'),(8,3,'2016-01-29 02:41:30',4,'Salida del sistema'),(9,2,'2016-01-29 02:41:35',4,'El usuario intentó acceder con una clave invalida'),(10,1,'2016-01-29 02:41:44',4,'Acceso correcto al sistema, Rol/es: Administrador.'),(11,3,'2016-01-29 02:48:01',4,'Salida del sistema'),(12,1,'2016-01-29 02:48:19',4,'Acceso correcto al sistema, Rol/es: Administrador.'),(13,3,'2016-01-29 02:48:26',4,'Salida del sistema'),(14,1,'2016-01-29 02:48:32',4,'Acceso correcto al sistema, Rol/es: Administrador.'),(15,3,'2016-01-29 03:27:13',4,'Salida del sistema'),(16,1,'2016-01-29 03:39:37',4,'Acceso correcto al sistema, Rol/es: Administrador.'),(17,3,'2016-01-29 03:59:27',4,'Salida del sistema'),(18,1,'2016-01-29 03:59:56',4,'Acceso correcto al sistema, Rol/es: Administrador.'),(19,3,'2016-01-29 04:09:27',4,'Salida del sistema'),(20,1,'2016-01-29 04:10:09',4,'Acceso correcto al sistema, Rol/es: Administrador.'),(21,3,'2016-01-29 04:10:22',4,'Salida del sistema'),(22,1,'2016-01-29 04:11:51',4,'Acceso correcto al sistema, Rol/es: Administrador.'),(23,3,'2016-01-29 04:11:57',4,'Salida del sistema'),(24,1,'2016-01-29 04:13:12',4,'Acceso correcto al sistema, Rol/es: Administrador.'),(25,1,'2016-01-30 04:16:14',4,'Acceso correcto al sistema, Rol/es: Administrador.'),(26,2,'2016-02-10 04:53:13',4,'El usuario intentó acceder con una clave invalida'),(27,2,'2016-02-10 04:53:28',4,'El usuario intentó acceder con una clave invalida'),(28,2,'2016-02-10 04:53:46',4,'El usuario intentó acceder con una clave invalida'),(29,2,'2016-02-10 04:53:55',4,'El usuario intentó acceder con una clave invalida'),(30,1,'2016-02-10 04:54:04',4,'Acceso correcto al sistema, Rol/es: Administrador.'),(31,3,'2016-02-10 04:55:52',4,'Salida del sistema'),(32,1,'2016-02-10 04:56:01',4,'Acceso correcto al sistema, Rol/es: Administrador.'),(33,2,'2016-02-18 02:04:54',4,'El usuario intentó acceder con una clave invalida'),(34,2,'2016-02-18 02:05:02',4,'El usuario intentó acceder con una clave invalida'),(35,1,'2016-02-18 02:05:27',4,'Acceso correcto al sistema, Rol/es: Administrador.'),(36,3,'2016-02-18 02:05:55',4,'Salida del sistema');
/*!40000 ALTER TABLE `tevent` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `teventtype`
--

DROP TABLE IF EXISTS `teventtype`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `teventtype` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cKey` varchar(20) NOT NULL,
  `cName` varchar(100) NOT NULL,
  PRIMARY KEY (`cId`),
  UNIQUE KEY `cKey` (`cKey`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `teventtype`
--

LOCK TABLES `teventtype` WRITE;
/*!40000 ALTER TABLE `teventtype` DISABLE KEYS */;
INSERT INTO `teventtype` VALUES (1,'SECURITY_LOGIN_OK','Acceso exitoso'),(2,'SECURITY_LOGIN_FAIL','Acceso fallido'),(3,'SECURITY_LOGOUT','Salida del sistema'),(4,'CONFIG_FAIL','Configuracion fallida en el sistema');
/*!40000 ALTER TABLE `teventtype` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `tfile`
--

DROP TABLE IF EXISTS `tfile`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tfile` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cFileName` varchar(255) NOT NULL COMMENT 'Nombre del archivo, es el identificador',
  `cDateTime` date NOT NULL COMMENT 'Fecha de creacion',
  `cSize` bigint(20) DEFAULT NULL COMMENT 'Tamano del archivo',
  PRIMARY KEY (`cId`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `tfile`
--

LOCK TABLES `tfile` WRITE;
/*!40000 ALTER TABLE `tfile` DISABLE KEYS */;
/*!40000 ALTER TABLE `tfile` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `tfilecontent`
--

DROP TABLE IF EXISTS `tfilecontent`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tfilecontent` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cFile` bigint(20) NOT NULL COMMENT 'relacion con la tabla tFile',
  `cLine` text COMMENT 'Es una fila del archivo',
  `cOrder` int(11) NOT NULL COMMENT 'Orden de la fila dentro del archivo',
  PRIMARY KEY (`cId`),
  KEY `FileContent_index_File` (`cFile`),
  CONSTRAINT `FileContentToFile` FOREIGN KEY (`cFile`) REFERENCES `tfile` (`cId`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `tfilecontent`
--

LOCK TABLES `tfilecontent` WRITE;
/*!40000 ALTER TABLE `tfilecontent` DISABLE KEYS */;
/*!40000 ALTER TABLE `tfilecontent` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `tfingerprint`
--

DROP TABLE IF EXISTS `tfingerprint`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tfingerprint` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cEmployee` bigint(20) NOT NULL,
  `cFingerprint` text,
  `cFlag` int(11) DEFAULT NULL,
  `cFingerIndex` int(11) DEFAULT NULL,
  `cCardNumber` varchar(20) DEFAULT NULL,
  PRIMARY KEY (`cId`),
  KEY `Fingerprin_index_Employee` (`cEmployee`),
  CONSTRAINT `Fingerprin_To_Employee` FOREIGN KEY (`cEmployee`) REFERENCES `temployee` (`cId`)
) ENGINE=InnoDB AUTO_INCREMENT=14 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `tfingerprint`
--

LOCK TABLES `tfingerprint` WRITE;
/*!40000 ALTER TABLE `tfingerprint` DISABLE KEYS */;
INSERT INTO `tfingerprint` VALUES (2,12,'ocoPgYkpI4EI7TdHwQUZPEwBBJEhOwEJCkwsAR9PtSABC2goHkEGab9LQQoeo0gBA4PBOEEUfzJSQQUTQzPBGwpNM4FJQxY9QRB9HDiBDwlHBLMMEBXjxAihrakUwMIAo9mdyZvAwWx1o+ityZsVwH5obHSj2a3KmRLAfmil7bvMuaqZwH5mpe6925qpmMBhpM7s7LmaEIHAYaW+3fzJmZkQwGGlrd7vyomaE8BfYGRocACj/qqaqMB+XmBka3UHovqruhvAflpcYGdwBA2i3MupwH5XWFxibAMOou3bucB+U1VYXmgBEBmh7bkpwMFSVVhdChyh/7iBwMFRUlNQQzCiiZd4wMJQo2QRV3Yz4AAAAA==',1,0,'0'),(3,1,'ocoQgYY9OlAQOcA/3wsyFierCe4dUmAPkKFW1Q4jn0UbBoq4WIcHnSAvFBMEozhRFHsnD1wE1LA5XCt0vC+rDEIjG+wIXcc34w86tjngRzM3NHEnRTpkDQ4QFeLEdAIGwMFnoczeBg4TwH5fpN3e/e3pwH5focvvA6L+3rjAfl1gZGlxAwsTod2pwH5aobzvAAwXoeq5JMB+WFlcYmsBDxmh6bglwH5WV1ldZXYRGqHrqSbAflWhib91FB2h2qgmwH5UgVVZZR2iy6mXwH5QoZiXRyyiKJmYwH5OoaeEQDKiB4iYwH5PoYdiPjWiI3eYwH5PoZZiPzahI2cpwMJOS0VAN6EQZyjAxEc/NaECecDFPTAmIyMkwMYkICIj4A==',1,0,'0'),(4,2,'ocoPgYkpI4EI7TdHwQUZPEwBBJEhOwEJCkwsAR9PtSABC2goHkEGab9LQQoeo0gBA4PBOEEUfzJSQQUTQzPBGwpNM4FJQxY9QRB9HDiBDwlHBLMMEBXjxAihrakUwMIAo9mdyZvAwWx1o+ityZsVwH5obHSj2a3KmRLAfmil7bvMuaqZwH5mpe6925qpmMBhpM7s7LmaEIHAYaW+3fzJmZkQwGGlrd7vyomaE8BfYGRocACj/qqaqMB+XmBka3UHovqruhvAflpcYGdwBA2i3MupwH5XWFxibAMOou3bucB+U1VYXmgBEBmh7bkpwMFSVVhdChyh/7iBwMFRUlNQQzCiiZd4wMJQo2QRV3Yz4AAAAA==',1,0,'0'),(5,3,'ocoJgHchIcEDELUigQZ8KR1BCwoeLEESgisuwQaDrSPBDHwxNgELD0EowQgLQCxBBn4QFeHEFBQVFMDDE6F5mBPAwQuirIqKFMB+BqO62aiYwH4Ho7nap5kUwH4IpKnKp5ppwH4KpImquIt5FMB+B6SLuriolsB+BaOa2ai3FMDBBKO8uppowMECo6j7uGnAwQKjqfnleBDAwQKjqtjIqBLAwQSjurjKqRfAwgcHCQ0Vofd1wMIGBAgOGKHUhcDDBAYNFqGnlsDECAwQ4AA=',1,0,'0'),(6,4,'ocoNgI1OPwEeKFA9wRAlTz0BEp3PNYEOnEMuwQkMNkbBCRfATEEKHck0wRgjTS4BCpbDNgEJgskoQQwcuygBDXooMQEMjhAV5sYPDsDFEA8QE8DEDqGmqRTAww2ie3p5wMIFo8nHp6rAwgajqrmZm8DBAaS7vKq42cDBc6TN7cuIu8DBcqPN7syaHcDCdaL+69odwMIFovy6y8DDE6HaqcDEHx8hI8DFICTgAAAA',1,0,'0'),(7,5,'ocoagYU3RYElMzo/ARI6ljZBBXgZMYEKcjgtwQ5ESChBCi46IIEJRMwSARsyIxzBBNyqR0EWeC9OgRZ9vE/BBy+4E8EHTjo1gQi7thyBCU3JWcEFoiceQQpeHx5BDGEvFgEKUqw4QRdeHjrBEHS2OoESR7MVgQTNFilBDO0SM8EK7w81AQ1yM0SNERAVwMZ44cNxoZvLCsDCbaKrzcwQwMFnpKzM7bzMwH5jpandz+vMvMB+YKGp3XIDovvMyh3Afl6huc1wAQmi7cuqH8B+XKGozG93Bw8XocqrIsB+XIFfYWhxBBIbocqqJcB+WaKHqd8BExyh6roowFaBoWmKWmwbos27h8BSonhYeU05J6JbqnfAUaJnN2dCOKIDiYcqwE6mZjVnQ0ZZhyvAT6ZTRFZWR2mGLMBPpkMiVmdYanYqwH5LpgA1Z3aHl0jAwT0ypUd5h4aHOMDCKaJ6eYkq4AAA',1,0,'0'),(8,6,'ocobgZorQkEnFbNZgQwvuWYBCS0zTQEQOdNLQQpcKD3BFOypY4EKHjxHwQtH0TbBDV2tVoEOJkNpwQw9qlIBERswbIEKmsE1AQdBTCeBCF6gUAERDKcxAQbcSycBDMxENwEGvp1GAQvuRC1BFlM5PoEIv48xQQVnmBmBBdgyNsERU6gmAQpXEVxBEQZGBKwPEBXhxWVpa8J4wMJgoqu7qn54wMFeo5vLq60EwH5ZpMrLqr3+DMB+V6XLy7u9/fzAflalzMq77v7bFsB+VaK8ys1yA6H/yxrAflSirMvPdgkTociqwMFUobvObgYXodmKIsDCVKG8zxwlgSMlJ8DDVFZXSzehFVeBwMNSVFBHogNERy/Aw0+jo0NTIy7Awk+BozVWM1fAwVGBo0Nnc1U4wMFUpJZEWEaHPsDBWaR3VTdId0LAwVqkl2ZldWdIwMJco4Z3ZmdQ4AAAAA==',1,0,'0'),(9,7,'ocoRgYVCNgEdVMI9ATxMJEBBBwQyZUEJGERsAQkjwWDBDCnGW8EdQ7hBgQ91MCiBCWuaRMEJf0hmwRo0zUPBFZBLR4EUC8lJwRScOB6BClysH0ELbz14AQ0bHvQwEBAV5MUCoa2pwMRwos3bqcDDbqKcvsoMwMNwo4y9u5nAwnGkqavLqZ3AwnCkqqzLuasUwMJspJy+zMupF8DCZmdscQGizv6JGsDBYaGZ7XYEDRUdHB0cwMFcoZnvdQUSGqHnp8DBV6GK3nAHFR+h14fAwlJUVlllGaHup4HAwk1OTUs2HyAqodVHwMNBPDgrJCMxNzApwMMpJyQZEg3AxB8dEAbg',1,0,'0'),(10,8,'ocoVgZckL4EWT6QpwRFTEECBC4ESOYEKegxKAQkXl2GBBiYvXAEFNktXQQZJtkwBBkBKPUEGyJdaQQyUokqBDivKTUEJUy1ogQQyFjtBDAozPUEIQRsngQ7evRvBCsQZNUEVcZwaQQVbFlCBBos8dGkOEBXAxwsQE8DEcHYHofy6wMNqbnYIof26HcDCZGdsdQmh/ssgwMJhZmp1CRGh7csjwMJcYWd0ChOh/cokwMFZWl5jcAwXofzLKcDBV1dZXGYUH6Hbqy3AwVSheIIxohmYqcDBT6F2QjiiJoh4wMFKpIdDJHd3McDBSaSHVFR3djPAwUmBo2ZVZmY1wMFMpJdmVmZVOMDBUKSHdVZlVTnAwVWkl2RGVUY7wMJao2ZEVlQ/wMJco3ZUVkTAw1yiVkZVR8DEWaFkdEvgAAAA',1,0,'0'),(11,10,'ocoYgY9IVAEuKUhagRIjpDUBBwCoVcEHELJsgQeKNF7BBIW2S8ENdsd1gQwn0mWBCp3GTcFQN0w2gQk+PkqBF2bKKwEKR1JPwQkpJUfBBn4sbQEHiq5CwQt0ITrBCnmrIQEKZclEwRY7zGzBCJ66FkEDVhguQQt7mE3BCoEphPETEBXixA6iibmYwMMJo6iquZrAwXSk2rqqu7kXwH5tpby8vJm7qMB+aKXMu765q6cSwH5mpbvbvsmquBPAfmWlu7y9zKu5FcB+ZaaarMzuu7qowH5hppm83f/LqqnAflyimazfAaL9ubsYwH5aoZiaZGx0BKLsu7rAfliBoZrPbgAIodzLGsB+V6J4mbtlcweh/8ocwMFUoomJq2wJERkdHh7AwVKBoXeFSh6hbLgkwMFMopd2UzgqoRi5KMDBR4GkZUMhN8otwMFCpYllNDJZ3DLAwkCkh0VDNa8z4AA=',1,0,'0'),(12,13,'ococgZVNMoETj88uQRyEOjKBEDe8K4ELP8AjwQ9OxCfBFUMwLwEMOsUswRkrFC0BDgoaRUEIjyBAgQsnO0pBCqspS8EDpJZSAQIeMylBC0Q4H4EJTK0kgR1HP2kBCabFakEQnc1UAQ6TRl1BD6DSWcENgcxJQRGRz0KBDIqrJ4FEPbIcAQlPqiXBVlQUUUEEk0l0ygkQFeLEBQoOFMDDdaH/3hzAw3QDDKH/yiLAwmtzBA8Xo+u5q4nAwmZxBhQeo9qamYnAwV1ibgwdofurhMDBWl9mGiah2ZmEwMFWWFI0pCmJmHiJwMFTUko9NKNniIeZM8DBUKVREUaIhqnAwVClQiE3eGmawH5TpVQiEXeHmjTAflWlUxAAaJepMcDBUk5GPTCjFYp6nMDBVVBGOSqjF4l5m8DCVE0yH6JniGkcwMNsDhaiaHiJFcDEBKL5lpgNwMUHoaloB+AAAAA=',1,0,'0'),(13,11,'SulTUzIxAAADqqoECAUHCc7QAAAbq2kBAAAAg1ccm6pMAIIPQQCYAG6l0QBiABwPFgCEqikPtQCUAFIPTKqkAF8PAgFsAKmljwDJAG0PdgDcqqkPCgHtAPsPkKrvACcNwwA1AKqk9QDwAEEPLAD0qkoP0AD6AE8Ohqr6AO0NtAA7AJyknAACAZYNCwAEq3oOcgAJARkPPaoQAdsPoADdAYGlgAAcAf0PpwArq+sPmwAqAbwPLqpBAeQNAQGCAWelAAFYAV4PymswRR5fTxMP7+LboV+6hvefypDTDXAp23C/fkcv/vfYXUY7c4cTb+ZrTeMrx1+B+QLfCEkrvP669bu3eD2KOEuB8SA5DbwCq1E4Bra5HA90wqF6PROR4PFCsMn6uKBaxfldCjQnJryYcuX6zPNw1pZ1jPLJ4vr1e/P0U6IBSQm57r+EKoibhH58iuyvES251PmefMrmqgmMVYILXQjD6xYb5lbO59sXZzbhBCOaAAI4IIAJxY0QrEP/QwQAadkAw1UIAJAdA/+Fwv1UAgBSKff/zwCDjwH/Pv/BNdQATp71O1PAN/0EVASqOkL0wDj/yQCTkwc9VMA7CcWUSSyFwFwVADWO+sGU/8D//0/C8P/8hgQAnE4J/zr/BKqVUIPBeMHNANDLEv7/OP4HxdJltFU+FwBjfjJB/Ff/Mv9G/yo5+yiiAWODcH7ASBYDvYbgQMBAPQX9Qmo5wRsA1YniVPzsRv7+/v7+O1RKamAaABqQ4oH/Q+vB/jPCK8A7RAyqspGaw8DDVnvBaoQZAByc4o/+/Gv8QcD9//6FSvxUwBIAUqPiOv4vkSo2JAgASmBnwM2ABwBPqWC9ZAarBK0xwDEZxRa2ef1XRf79Qew1w1VHDQCLyHcAw8KUQ4ETALHcaMKMbsXD/8NMYKkDAy/sU/4WAMAprWVrw8TEw8RqBMH98VgYAM/ut6zC/GnAn8OLwMKdXQ2rCfFAPf79Ov405gQAl/Ikw1wNAqTzOjD+Kf87UxuqzvOiLcCIAcSY/Hn//zASADT0PoD8/v3/RYc6hRKq+fRANP/99ULBVXEQAMX4nDpCqW9//00RAOY/Sf1UGsDAwJB4BRIDQftD/v77/zj+w2j+wmTCjg/FsP42/8DEzMTAOv/DVMHB/RMAxDuP/+jGx8TC//86wPxq/sLEERDOznD/hcLGdEzAyTsFEzYSicWVChBTKnlrwMHBbsME1BBD7Pz/BRD9SKLANK8QBEtg/jA=',1,0,'0');
/*!40000 ALTER TABLE `tfingerprint` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `tfiscaldate`
--

DROP TABLE IF EXISTS `tfiscaldate`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tfiscaldate` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cDate` date NOT NULL,
  `cReason` varchar(50) DEFAULT '',
  PRIMARY KEY (`cId`),
  UNIQUE KEY `cDate` (`cDate`)
) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `tfiscaldate`
--

LOCK TABLES `tfiscaldate` WRITE;
/*!40000 ALTER TABLE `tfiscaldate` DISABLE KEYS */;
INSERT INTO `tfiscaldate` VALUES (1,'2011-08-01',''),(2,'2011-08-02',''),(3,'2012-09-17',''),(4,'2012-09-18',''),(5,'2012-09-19',''),(6,'2014-07-16','Día de la Virgen del Carmen'),(7,'2014-08-15','Asunción de la Virgen'),(8,'2014-09-18','Independencia Nacional'),(9,'2014-09-19','Glorias del ejercito');
/*!40000 ALTER TABLE `tfiscaldate` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `tgroup`
--

DROP TABLE IF EXISTS `tgroup`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tgroup` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cKey` varchar(10) NOT NULL,
  `cName` varchar(50) NOT NULL,
  PRIMARY KEY (`cId`),
  UNIQUE KEY `cKey` (`cKey`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `tgroup`
--

LOCK TABLES `tgroup` WRITE;
/*!40000 ALTER TABLE `tgroup` DISABLE KEYS */;
INSERT INTO `tgroup` VALUES (1,'MAIN','Grupo Principal'),(2,'SECOND','Segundo Grupo ');
/*!40000 ALTER TABLE `tgroup` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `tlicense`
--

DROP TABLE IF EXISTS `tlicense`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tlicense` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cEmployee` bigint(20) NOT NULL COMMENT 'Identificador del empleado quien tiene las horas extras',
  `cStartDate` date NOT NULL COMMENT 'Día del período de comienzo de licencia',
  `cEndDate` date NOT NULL COMMENT 'Día del período de término de licencia',
  `cLicenseCause` bigint(20) NOT NULL COMMENT 'Razon de la aucencia',
  `cDocument` varchar(15) DEFAULT NULL COMMENT 'Numero de documento',
  PRIMARY KEY (`cId`),
  KEY `License_index_LicenseCause` (`cLicenseCause`),
  KEY `License_index_Employee` (`cEmployee`),
  CONSTRAINT `LicenseToEmployee` FOREIGN KEY (`cEmployee`) REFERENCES `temployee` (`cId`),
  CONSTRAINT `LicenseToLicenseCause` FOREIGN KEY (`cLicenseCause`) REFERENCES `tlicensecause` (`cId`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `tlicense`
--

LOCK TABLES `tlicense` WRITE;
/*!40000 ALTER TABLE `tlicense` DISABLE KEYS */;
/*!40000 ALTER TABLE `tlicense` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `tlicensecause`
--

DROP TABLE IF EXISTS `tlicensecause`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tlicensecause` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cName` varchar(30) NOT NULL COMMENT 'Descripción de la causa',
  PRIMARY KEY (`cId`),
  UNIQUE KEY `cId` (`cId`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `tlicensecause`
--

LOCK TABLES `tlicensecause` WRITE;
/*!40000 ALTER TABLE `tlicensecause` DISABLE KEYS */;
/*!40000 ALTER TABLE `tlicensecause` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `tmachine`
--

DROP TABLE IF EXISTS `tmachine`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tmachine` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cName` varchar(50) NOT NULL DEFAULT '',
  `cIP` varchar(50) DEFAULT NULL,
  `cPort` int(11) NOT NULL,
  `cLastAccess` timestamp NULL DEFAULT NULL,
  `cSerial` varchar(20) DEFAULT NULL COMMENT 'Numero de Serie',
  `cGroup` bigint(20) NOT NULL,
  PRIMARY KEY (`cId`),
  KEY `machine_index_group` (`cGroup`),
  CONSTRAINT `MachineToGroup` FOREIGN KEY (`cGroup`) REFERENCES `tgroup` (`cId`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `tmachine`
--

LOCK TABLES `tmachine` WRITE;
/*!40000 ALTER TABLE `tmachine` DISABLE KEYS */;
INSERT INTO `tmachine` VALUES (1,'reloj 1','192.168.0.22',4370,'2016-01-29 04:15:56','0339141100011',1),(2,'Reloj 2','192.168.0.25',4370,'2016-01-30 04:20:35','0339141100036',2);
/*!40000 ALTER TABLE `tmachine` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `tmarktype`
--

DROP TABLE IF EXISTS `tmarktype`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tmarktype` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cKey` varchar(1) NOT NULL,
  `cName` varchar(20) NOT NULL,
  PRIMARY KEY (`cId`),
  UNIQUE KEY `cKey` (`cKey`)
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `tmarktype`
--

LOCK TABLES `tmarktype` WRITE;
/*!40000 ALTER TABLE `tmarktype` DISABLE KEYS */;
INSERT INTO `tmarktype` VALUES (1,'0','Entrada'),(2,'2','Colación'),(3,'3','Vuelta'),(4,'1','Salida'),(5,'4','Otra entrada'),(6,'5','Otra salida');
/*!40000 ALTER TABLE `tmarktype` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `toption`
--

DROP TABLE IF EXISTS `toption`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `toption` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cKey` varchar(20) NOT NULL,
  `cLabel` varchar(50) NOT NULL,
  `cUrl` varchar(100) DEFAULT NULL,
  `cParent` bigint(20) DEFAULT NULL,
  `cType` bigint(20) NOT NULL DEFAULT '1',
  `cOrder` int(11) NOT NULL DEFAULT '0',
  `cEnable` bit(1) NOT NULL DEFAULT b'1',
  `cIsAdmin` bit(1) NOT NULL DEFAULT b'0',
  PRIMARY KEY (`cId`),
  UNIQUE KEY `cKey` (`cKey`)
) ENGINE=InnoDB AUTO_INCREMENT=34 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `toption`
--

LOCK TABLES `toption` WRITE;
/*!40000 ALTER TABLE `toption` DISABLE KEYS */;
INSERT INTO `toption` VALUES (1,'SYSTEM','Sistema',NULL,NULL,1,1,'','\0'),(2,'USER','Usuarios','/servlet/system/user/UserManager',1,1,1,'','\0'),(3,'ALLOW','Permisos de roles','/servlet/system/roleDef/RoleDef',1,1,3,'','\0'),(4,'CH_PASS','Cambio de clave','/servlet/system/changepassword/SearchPassword',1,1,4,'','\0'),(5,'ROL','Roles','/servlet/system/role/RolManager',1,1,2,'','\0'),(6,'PARAMS','Parámetros','/servlet/config/systemparams/ParameterManager',1,1,5,'','\0'),(7,'CONFIG','Configuración del Sistema',NULL,NULL,1,2,'','\0'),(8,'EMPLOYEE','Empleados','/servlet/config/employee/EmployeeManager',7,1,1,'','\0'),(9,'TABLES','Tablas',NULL,7,1,2,'','\0'),(10,'POST','Cargos','/servlet/config/employee/PostManager',9,1,1,'','\0'),(11,'AREA','Areas','/servlet/config/employee/AreaManager',9,1,2,'','\0'),(12,'TURN','Config. Turnos','/servlet/timectrl/turns/TurnManager',9,1,3,'','\0'),(13,'FISCAL_DATE','Feriados','/servlet/timectrl/fiscalDate/FiscalDateManager',9,1,4,'','\0'),(14,'MACHINE','Relojes','/servlet/timectrl/machine/MachineManager',9,1,5,'','\0'),(15,'LICENSE_CAUSE','Permisos y licencias','/servlet/timectrl/licenseCause/LicenseCauseManager',9,1,6,'','\0'),(16,'REPORT','Consultas y Reportes',NULL,NULL,1,3,'','\0'),(17,'FILES','Archivos','/servlet/timectrl/files/FilesManager',16,1,1,'\0','\0'),(18,'SUMMARY','Resumenes','/servlet/timectrl/report/Summary',16,1,2,'\0','\0'),(19,'DETAIL','Detalles',NULL,16,1,3,'\0','\0'),(20,'REP_ASIST','Reporte de Asistencia','/servlet/timectrl/report/execute/ReadParameters?reportId=1',16,1,4,'','\0'),(21,'REP_WEEKLY','Reporte por Semana','/servlet/timectrl/report/execute/ReadParameters?reportId=7',16,1,5,'','\0'),(22,'REP_PLAIN','Reporte Completo (xls)','/servlet/timectrl/report/execute/ReadParameters?reportId=5',16,1,6,'','\0'),(23,'REP_LATE','Reporte Atrasos','/servlet/timectrl/report/execute/ReadParameters?reportId=8',16,1,7,'','\0'),(24,'REP_ABSENCE','Reporte Inasistencias','/servlet/timectrl/report/execute/ReadParameters?reportId=6',16,1,8,'','\0'),(25,'REP_CONFIG','Configuración reportes',NULL,16,1,9,'','\0'),(26,'REP_CFG_OUT_TYPE','Tipos de reportes','/servlet/timectrl/report/config/ReportTypeManager',25,1,3,'\0','\0'),(28,'REP_LIST','Lista de Reportes','/servlet/timectrl/report/config/ReportManager',25,1,1,'','\0'),(29,'EXECUTE_REPORT','Ejecución de reportes','/servlet/timectrl/report/execute/ExecutionReport',16,1,10,'','\0'),(30,'GROUP_MGR','Grupos','/servlet/timectrl/group/GroupManager',9,1,7,'','\0'),(31,'DOMAIN_MGR','Dominios','/servlet/system/DomainManager',1,1,6,'',''),(32,'DOMAIN_ATTR_MGR','Atributos de Dominios','/servlet/system/DomainAttributeManager',1,1,7,'',''),(33,'EVENT_VIEWER','Visor de eventos','/servlet/admin/eventViewer/EventViewerMain',7,1,3,'','\0');
/*!40000 ALTER TABLE `toption` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `tparameter`
--

DROP TABLE IF EXISTS `tparameter`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tparameter` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cKey` varchar(20) NOT NULL,
  `cLabel` varchar(100) NOT NULL,
  `cValue` varchar(300) NOT NULL,
  `cDataType` bigint(20) NOT NULL,
  PRIMARY KEY (`cId`),
  UNIQUE KEY `cId` (`cId`),
  UNIQUE KEY `cKey` (`cKey`),
  KEY `Parameter_index` (`cDataType`),
  CONSTRAINT `ParameterToDataType` FOREIGN KEY (`cDataType`) REFERENCES `tdatatype` (`cId`)
) ENGINE=InnoDB AUTO_INCREMENT=30 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `tparameter`
--

LOCK TABLES `tparameter` WRITE;
/*!40000 ALTER TABLE `tparameter` DISABLE KEYS */;
INSERT INTO `tparameter` VALUES (1,'FORMAT_DATE','Formato de Fecha','dd-MM-yyyy',1),(2,'FORMAT_DATETIME','Formado de fecha/hora','dd-MM-yyyy HH:mm:ss',1),(3,'LOCALE','Región, afecta a formato de n&uacute;meros(ISO-639)','ES',1),(4,'PATTERN_INTEGER','Formato para montos enteros','###.###.##0',1),(5,'PATTERN_DECIMAL','Formato para montos con decimales','###.###.##0,00###',1),(6,'CSV_SEPARATOR','Separador de archivos csv',';',1),(7,'RECORDS_PER_PAGE','Registros por p&aacute;gina','15',3),(8,'EMPLOYEE_FILES','Ubicaci&oacute;n de archivos de empleados (en server)','D:\\temp\\remcon',1),(9,'EMULATE','Simula interfaz de reloj control','false',5),(10,'ATTENDANCE_REPORT','Archivo de reporte de asistencia','D:\\workspace\\timectrl-web\\WebContent\\WEB-INF\\sql\\timecontrol\\reporte-horas.jasper',1),(11,'WEEKLY_REPORT','Archivo de reporte de asistencia, semanal','D:\\workspace\\timectrl-web\\WebContent\\WEB-INF\\report\\weekly-main.jasper',1),(13,'LATE_REPORT','Archivo de reporte para retrazados','D:\\workspace\\timectrl-web\\WebContent\\WEB-INF\\sql\\timecontrol\\rpt_RSA_Atrasos_Tabla.jasper',1),(14,'OUTPUT_LATE_NAME','Archivo del reporte de retrazo','Reporte_de_atrazados.pdf',1),(15,'OUTPUT_REPORT','Carpeta donde va a dejar los archivos de reporte','D:\\temp\\7\\temp\\reportes-generados',1),(16,'ABSENCE_REPORT','Archivo de reporte para inasistencias','D:\\workspace\\timectrl-web\\WebContent\\WEB-INF\\sql\\timecontrol\\Inasistencas.jasper',1),(17,'OUTPUT_ABSENCE_NAME','Archivo de inasistencias','Reporte_de_inasistencias.pdf',1),(19,'RANGE_MARK','Rango para administracion de marcas','7',3),(20,'AREA_FILTER','Indica si se filtran los empleados por area','false',5),(21,'JASPER_FOLDER','Carpeta donde destan los archivos jasper','E:\\workspace\\timectrl-web\\WebContent\\WEB-INF\\report',1),(22,'INFER_TIME1','Horario 1 de finferencia de turno rotativo','00:00:00',1),(23,'INFER_TIME2','Horario 2 de finferencia de turno rotativo','08:00:00',1),(24,'INFER_TIME3','Horario 3 de finferencia de turno rotativo','16:00:00',1),(25,'INFER_TIME4','Horario 4 de finferencia de turno rotativo','20:00:00',1),(26,'TOLERANCE_INFERENCE','Tolerancia Horario diferido (minutos)','180',3),(27,'EMPLOYEE_ORDER','Campo con el que se ordenan los empleados. default \"CAST(tEmployee.cKey AS UNSIGNED)\"','cRut',1),(28,'BOOTSTRAP','Uso de interfaz bootstrap en las pantallas que estan habilitadas para esto','true',5),(29,'BOTH_MARKS','Considera marca de entrada y salida para contabilizar un día en informe','true',5);
/*!40000 ALTER TABLE `tparameter` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `tpost`
--

DROP TABLE IF EXISTS `tpost`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tpost` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cKey` varchar(10) NOT NULL,
  `cName` varchar(20) NOT NULL,
  PRIMARY KEY (`cId`),
  UNIQUE KEY `cKey` (`cKey`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `tpost`
--

LOCK TABLES `tpost` WRITE;
/*!40000 ALTER TABLE `tpost` DISABLE KEYS */;
INSERT INTO `tpost` VALUES (1,'EMP','Empleado.');
/*!40000 ALTER TABLE `tpost` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `tprivilege`
--

DROP TABLE IF EXISTS `tprivilege`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tprivilege` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cKey` int(11) NOT NULL,
  `cName` varchar(20) NOT NULL,
  PRIMARY KEY (`cId`),
  UNIQUE KEY `cKey` (`cKey`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `tprivilege`
--

LOCK TABLES `tprivilege` WRITE;
/*!40000 ALTER TABLE `tprivilege` DISABLE KEYS */;
INSERT INTO `tprivilege` VALUES (1,0,'Usuario común'),(2,1,'Enrolador'),(3,2,'Administrador'),(4,3,'Super administrador');
/*!40000 ALTER TABLE `tprivilege` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `tr_employeeturn`
--

DROP TABLE IF EXISTS `tr_employeeturn`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tr_employeeturn` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cEmployee` bigint(20) NOT NULL,
  `cTurn` bigint(20) NOT NULL,
  `cStartDate` date DEFAULT NULL,
  `cEndDate` date DEFAULT NULL,
  `cException` bit(1) NOT NULL DEFAULT b'0',
  PRIMARY KEY (`cId`),
  KEY `R_EmployeeTurn_index_Employee` (`cEmployee`),
  KEY `R_EmployeeTurn_index_Turn` (`cTurn`),
  CONSTRAINT `R_EmployeeTurn_To_Employee` FOREIGN KEY (`cEmployee`) REFERENCES `temployee` (`cId`),
  CONSTRAINT `R_EmployeeTurn_To_Turn` FOREIGN KEY (`cTurn`) REFERENCES `tturn` (`cId`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `tr_employeeturn`
--

LOCK TABLES `tr_employeeturn` WRITE;
/*!40000 ALTER TABLE `tr_employeeturn` DISABLE KEYS */;
/*!40000 ALTER TABLE `tr_employeeturn` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `tr_reportpropertytype_reporttype`
--

DROP TABLE IF EXISTS `tr_reportpropertytype_reporttype`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tr_reportpropertytype_reporttype` (
  `cReportType` bigint(20) NOT NULL,
  `cReportPropertyType` bigint(20) NOT NULL,
  PRIMARY KEY (`cReportType`,`cReportPropertyType`),
  KEY `index_ReportType` (`cReportType`),
  KEY `index_ReportPropertyType` (`cReportPropertyType`),
  CONSTRAINT `r_ToReportPropertyType` FOREIGN KEY (`cReportPropertyType`) REFERENCES `treportpropertytype` (`cId`),
  CONSTRAINT `r_ToReportType` FOREIGN KEY (`cReportType`) REFERENCES `treporttype` (`cId`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `tr_reportpropertytype_reporttype`
--

LOCK TABLES `tr_reportpropertytype_reporttype` WRITE;
/*!40000 ALTER TABLE `tr_reportpropertytype_reporttype` DISABLE KEYS */;
INSERT INTO `tr_reportpropertytype_reporttype` VALUES (1,1),(1,2),(1,4),(1,5),(1,8),(4,1),(4,4),(4,9),(4,10),(4,11),(4,12),(4,13),(4,14),(4,15),(5,16),(5,17),(5,18),(5,19),(5,20),(5,21),(5,22),(5,23),(5,24),(5,25),(5,26),(6,1),(6,4),(6,9),(6,10),(6,11),(6,12),(6,13),(6,14),(6,15),(6,27),(6,28),(6,29);
/*!40000 ALTER TABLE `tr_reportpropertytype_reporttype` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `tr_roloption`
--

DROP TABLE IF EXISTS `tr_roloption`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tr_roloption` (
  `cRol` bigint(20) NOT NULL,
  `cOption` bigint(20) NOT NULL,
  PRIMARY KEY (`cRol`,`cOption`),
  KEY `index_rol` (`cRol`),
  KEY `index_option` (`cOption`),
  CONSTRAINT `RolOption_To_Option` FOREIGN KEY (`cOption`) REFERENCES `toption` (`cId`),
  CONSTRAINT `RolOption_To_Rol` FOREIGN KEY (`cRol`) REFERENCES `trol` (`cId`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `tr_roloption`
--

LOCK TABLES `tr_roloption` WRITE;
/*!40000 ALTER TABLE `tr_roloption` DISABLE KEYS */;
INSERT INTO `tr_roloption` VALUES (1,1),(1,2),(1,3),(1,4),(1,5),(1,6),(1,7),(1,8),(1,9),(1,10),(1,11),(1,12),(1,13),(1,14),(1,15),(1,16),(1,20),(1,21),(1,22),(1,23),(1,24),(1,25),(1,28),(1,29),(1,30),(1,31),(1,32),(1,33);
/*!40000 ALTER TABLE `tr_roloption` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `tr_userrol`
--

DROP TABLE IF EXISTS `tr_userrol`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tr_userrol` (
  `cUser` bigint(20) NOT NULL,
  `cRol` bigint(20) NOT NULL,
  PRIMARY KEY (`cUser`,`cRol`),
  KEY `index_rol` (`cRol`),
  KEY `index_user` (`cUser`),
  CONSTRAINT `r_UserRolToRol` FOREIGN KEY (`cRol`) REFERENCES `trol` (`cId`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `tr_userrol`
--

LOCK TABLES `tr_userrol` WRITE;
/*!40000 ALTER TABLE `tr_userrol` DISABLE KEYS */;
INSERT INTO `tr_userrol` VALUES (1,1),(4,1);
/*!40000 ALTER TABLE `tr_userrol` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `treport`
--

DROP TABLE IF EXISTS `treport`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `treport` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cKey` varchar(20) NOT NULL,
  `cName` varchar(50) NOT NULL,
  `cType` bigint(20) NOT NULL,
  `cJavaClass` varchar(512) DEFAULT NULL,
  PRIMARY KEY (`cId`),
  UNIQUE KEY `cKey` (`cKey`),
  KEY `Report_index_ReportOutType` (`cType`),
  CONSTRAINT `Report_To_ReportOutType` FOREIGN KEY (`cType`) REFERENCES `treporttype` (`cId`)
) ENGINE=InnoDB AUTO_INCREMENT=9 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `treport`
--

LOCK TABLES `treport` WRITE;
/*!40000 ALTER TABLE `treport` DISABLE KEYS */;
INSERT INTO `treport` VALUES (1,'1','Reporte de asistencia',1,NULL),(5,'PLAIN_EXCEL','Reporte Completo (xls)',4,NULL),(6,'ABSENCE','Reporte Inasistencias',4,NULL),(7,'WEEKLY','Reporte por Semanas',1,NULL),(8,'LATER','Reporte Atrasos',4,NULL);
/*!40000 ALTER TABLE `treport` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `treportparameter`
--

DROP TABLE IF EXISTS `treportparameter`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `treportparameter` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cReport` bigint(20) NOT NULL,
  `cName` varchar(20) NOT NULL,
  `cLabel` varchar(50) NOT NULL,
  `cType` bigint(20) NOT NULL,
  `cOrder` int(11) DEFAULT NULL,
  PRIMARY KEY (`cId`),
  KEY `ReportParam_index_Report` (`cReport`),
  KEY `ReportParam_index_Type` (`cType`),
  CONSTRAINT `ReportParam_To_Report` FOREIGN KEY (`cReport`) REFERENCES `treport` (`cId`),
  CONSTRAINT `ReportParam_To_ReportParamType` FOREIGN KEY (`cType`) REFERENCES `treportparametertype` (`cId`)
) ENGINE=InnoDB AUTO_INCREMENT=19 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `treportparameter`
--

LOCK TABLES `treportparameter` WRITE;
/*!40000 ALTER TABLE `treportparameter` DISABLE KEYS */;
INSERT INTO `treportparameter` VALUES (1,1,'Employee','Empleado',1,1),(2,1,'StartDate','StartDate',2,2),(3,1,'EndDate','EndDate',2,3),(9,5,'StartDate','StartDate',2,1),(10,5,'EndDate','EndDate',2,2),(12,6,'absenceDate','absenceDate',2,1),(14,7,'EmployeeId','EmployeeId',1,1),(15,7,'Month','Month',4,2),(16,7,'Year','Year',6,3),(17,8,'StartDate','StartDate',2,1),(18,8,'EndDate','EndDate',2,2);
/*!40000 ALTER TABLE `treportparameter` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `treportparametertype`
--

DROP TABLE IF EXISTS `treportparametertype`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `treportparametertype` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cKey` varchar(20) NOT NULL,
  `cName` varchar(20) NOT NULL,
  `cHTMLFile` varchar(50) NOT NULL,
  `cSource` varchar(512) DEFAULT NULL,
  `cJavaType` varchar(10) DEFAULT NULL,
  PRIMARY KEY (`cId`),
  UNIQUE KEY `cKey` (`cKey`)
) ENGINE=InnoDB AUTO_INCREMENT=9 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `treportparametertype`
--

LOCK TABLES `treportparametertype` WRITE;
/*!40000 ALTER TABLE `treportparametertype` DISABLE KEYS */;
INSERT INTO `treportparametertype` VALUES (1,'EMPLOYEE_LIST','Lista de empleados','Employee.jsp','cl.buildersoft.timectrl.business.services.impl.ParameterEmployeeImpl','LONG'),(2,'DATE','Ingreso de fecha','InputDate.jsp','','DATE'),(3,'SP','Store Procedure','',NULL,NULL),(4,'MONTH','Meses','Month.jsp',NULL,'INTEGER'),(6,'YEAR','Año','Year.jsp',NULL,'INTEGER'),(7,'BOSS_LIST','Listado de jefes','EmployeeList.jsp','cl.buildersoft.timectrl.business.services.impl.ParameterListBoss','LONG'),(8,'INTEGER','Valor Entero','Integer.jsp','','INTEGER');
/*!40000 ALTER TABLE `treportparametertype` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `treportproperty`
--

DROP TABLE IF EXISTS `treportproperty`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `treportproperty` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cPropertyType` bigint(20) NOT NULL,
  `cReport` bigint(20) NOT NULL,
  `cValue` varchar(255) NOT NULL,
  PRIMARY KEY (`cId`),
  KEY `reportProperty_index_reportPropertyType` (`cPropertyType`),
  KEY `reportProperty_index_Report` (`cReport`),
  CONSTRAINT `ReportPropertyToReport` FOREIGN KEY (`cReport`) REFERENCES `treport` (`cId`),
  CONSTRAINT `ReportPropertyToReportPropertyType` FOREIGN KEY (`cPropertyType`) REFERENCES `treportpropertytype` (`cId`)
) ENGINE=InnoDB AUTO_INCREMENT=57 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `treportproperty`
--

LOCK TABLES `treportproperty` WRITE;
/*!40000 ALTER TABLE `treportproperty` DISABLE KEYS */;
INSERT INTO `treportproperty` VALUES (1,1,1,'r-{Date}_{Year}_{Month}_{EmployeeKey}_{EmployeeRut}.pdf'),(2,2,1,'pdf'),(13,1,5,'MarcasPlain_{Date}.xls'),(14,4,5,'D:\\temp\\7\\temp\\reportes-generados'),(15,1,6,'Inasistencias_{Date}.xls'),(16,4,6,'D:\\temp\\7\\temp\\reportes-generados'),(17,1,7,'Semanal-{Date}_{Year}_{Month}_{EmployeeKey}.pdf'),(18,4,7,'D:\\ReportesAsistencia\\{UserName}\\{Year}\\{Month}'),(19,1,8,'Atrasos_{Date}.xls'),(20,4,8,'D:\\temp\\7\\temp\\reportes-generados'),(21,5,1,'rpt_AsistenciaPDF_v2.jasper'),(27,5,7,'weekly-main.jasper'),(32,4,1,'D:\\ReportesAsistencia\\{CostCenter}\\{Year}\\{Month}'),(33,8,1,'D:\\workspace\\timectrl-web\\WebContent\\WEB-INF\\report\\Enlasa'),(34,9,5,'pListAttendanceAsExcel3'),(35,9,6,'pAbsence'),(36,9,8,'pListLater'),(37,2,7,'pdf'),(38,8,7,'D:\\workspace\\timectrl-web\\WebContent\\WEB-INF\\report'),(39,10,5,'#190033'),(40,11,5,'#E0E0E0'),(41,12,5,'#FFFF99'),(42,13,5,'#660000'),(43,14,5,'Trebuchet MS'),(44,15,5,'10'),(45,10,6,'#190033'),(46,11,6,'#E0E0E0'),(47,12,6,'#FFFF99'),(48,13,6,'#660000'),(49,14,6,'Trebuchet MS'),(50,15,6,'10'),(51,10,8,'#190033'),(52,11,8,'#E0E0E0'),(53,12,8,'#FFFF99'),(54,13,8,'#660000'),(55,14,8,'Trebuchet MS'),(56,15,8,'10');
/*!40000 ALTER TABLE `treportproperty` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `treportpropertytype`
--

DROP TABLE IF EXISTS `treportpropertytype`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `treportpropertytype` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cKey` varchar(30) NOT NULL,
  `cName` varchar(100) NOT NULL DEFAULT '',
  PRIMARY KEY (`cId`),
  UNIQUE KEY `cKey` (`cKey`),
  UNIQUE KEY `cKey_2` (`cKey`)
) ENGINE=InnoDB AUTO_INCREMENT=30 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `treportpropertytype`
--

LOCK TABLES `treportpropertytype` WRITE;
/*!40000 ALTER TABLE `treportpropertytype` DISABLE KEYS */;
INSERT INTO `treportpropertytype` VALUES (1,'OUTPUT_FILE','Nombre del archivo de salida'),(2,'FORMAT','Formato de salida (pdf o xls)'),(3,'SEPARATED','Separado por area + fecha'),(4,'OUTPUT_PATH','Carpeta de Salida'),(5,'JASPER_FILE','Archivo de iReport'),(8,'JASPER_PATH','Carpeta donde esta el archivo jasper'),(9,'SP','Nombre del SP a ejecutar'),(10,'BG_COLOR_HEAD','Color de fondo en cabecera'),(11,'FONT_COLOR_HEAD','Color de letra en cabecera'),(12,'BG_COLOR_CELL','Color de fondo en el contenido'),(13,'FONT_COLOR_CELL','Color de letra en contenido'),(14,'FONT_NAME','Tipo de Letra'),(15,'FONT_SIZE','Tamaño de letra'),(16,'SUB_REPORT','Sub-Reporte (Reporte a enviar)'),(17,'mail.smtp.host','Servidor de correo (smtp.gmail.com)'),(18,'mail.smtp.port','Puerto del servidor (587)'),(19,'mail.smtp.starttls.enable','Habilitacion de TLS [true|false] default:true'),(20,'mail.smtp.auth','Usa autenticacion [true|false] default:true'),(21,'mail.smtp.user','Usuario de correo'),(22,'mail.smtp.password','Clave de correo'),(23,'SUBJECT','Asunto'),(24,'TEXT','Texto del mensaje'),(25,'DESTINY','Destinatario del correo [MANPOWER, EACH_ONE, BOSS_ONLY]'),(26,'MANPOWER_MAIL','Casilla de correo de Recursos Humanos'),(27,'SP_SUMMARY','Procedimiento Almacenado que genera el detalle'),(28,'COLS_AS_TITLE','Cantidad Columns como titulo de la sub tabla'),(29,'EMPLOYEE_DEPTH','Profundidad de nileves de empleados a considerar (0=todos)');
/*!40000 ALTER TABLE `treportpropertytype` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `treporttype`
--

DROP TABLE IF EXISTS `treporttype`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `treporttype` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cKey` varchar(20) NOT NULL,
  `cName` varchar(50) NOT NULL,
  `cJavaClass` varchar(512) DEFAULT NULL,
  PRIMARY KEY (`cId`),
  UNIQUE KEY `cKey` (`cKey`),
  UNIQUE KEY `cKey_2` (`cKey`)
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `treporttype`
--

LOCK TABLES `treporttype` WRITE;
/*!40000 ALTER TABLE `treporttype` DISABLE KEYS */;
INSERT INTO `treporttype` VALUES (1,'FILE','Generacion de archivos','cl.buildersoft.timectrl.business.services.impl.FileReportImpl'),(4,'PLAIN_EXCEL','Listado Excel','cl.buildersoft.timectrl.business.services.impl.ListToXExcelImpl'),(5,'SEND_BY_MAIL','Envio reporte por correo','cl.buildersoft.timectrl.business.services.impl.SendReportByMailImpl'),(6,'EXCEL_2','Excel con hoja resumen y detalle','cl.buildersoft.timectrl.business.services.impl.XExcel2Impl');
/*!40000 ALTER TABLE `treporttype` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `trol`
--

DROP TABLE IF EXISTS `trol`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `trol` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cName` varchar(50) DEFAULT NULL,
  `cDeleted` bit(1) NOT NULL DEFAULT b'0',
  PRIMARY KEY (`cId`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `trol`
--

LOCK TABLES `trol` WRITE;
/*!40000 ALTER TABLE `trol` DISABLE KEYS */;
INSERT INTO `trol` VALUES (1,'Administrador','\0');
/*!40000 ALTER TABLE `trol` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `ttimectrl`
--

DROP TABLE IF EXISTS `ttimectrl`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `ttimectrl` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cFile` bigint(20) NOT NULL,
  `cEmployeeKey` varchar(15) NOT NULL,
  `cDate` date NOT NULL,
  `cTurn` varchar(5) DEFAULT NULL,
  `cOnDuty` time DEFAULT NULL,
  `cOffDuty` time DEFAULT NULL,
  `cClockIn` time DEFAULT NULL,
  `cClockOut` time DEFAULT NULL,
  `cLate` time DEFAULT NULL,
  `cEarly` time DEFAULT NULL,
  `cWorkTime` time DEFAULT NULL,
  `cWeekEnd` bit(1) DEFAULT NULL,
  `cHoliday` bit(1) DEFAULT NULL,
  PRIMARY KEY (`cId`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `ttimectrl`
--

LOCK TABLES `ttimectrl` WRITE;
/*!40000 ALTER TABLE `ttimectrl` DISABLE KEYS */;
/*!40000 ALTER TABLE `ttimectrl` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `tturn`
--

DROP TABLE IF EXISTS `tturn`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tturn` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cName` varchar(20) NOT NULL,
  `cFlexible` bit(1) NOT NULL DEFAULT b'0',
  PRIMARY KEY (`cId`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `tturn`
--

LOCK TABLES `tturn` WRITE;
/*!40000 ALTER TABLE `tturn` DISABLE KEYS */;
/*!40000 ALTER TABLE `tturn` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `tturnday`
--

DROP TABLE IF EXISTS `tturnday`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tturnday` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cTurn` bigint(20) NOT NULL,
  `cDay` int(11) NOT NULL,
  `cBusinessDay` tinyint(1) NOT NULL DEFAULT '1',
  `cEdgePrevIn` int(11) NOT NULL DEFAULT '0',
  `cStartTime` varchar(5) NOT NULL,
  `cEdgePostIn` int(11) NOT NULL DEFAULT '0',
  `cEdgePrevOut` int(11) NOT NULL DEFAULT '0',
  `cEndTime` varchar(5) NOT NULL,
  `cEdgePostOut` int(11) NOT NULL DEFAULT '0',
  PRIMARY KEY (`cId`),
  KEY `TurnDay_index_Turn` (`cTurn`),
  CONSTRAINT `TurnDay_To_Turn` FOREIGN KEY (`cTurn`) REFERENCES `tturn` (`cId`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `tturnday`
--

LOCK TABLES `tturnday` WRITE;
/*!40000 ALTER TABLE `tturnday` DISABLE KEYS */;
/*!40000 ALTER TABLE `tturnday` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Table structure for table `tversion`
--

DROP TABLE IF EXISTS `tversion`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tversion` (
  `cId` bigint(20) NOT NULL AUTO_INCREMENT,
  `cKey` varchar(3) NOT NULL COMMENT 'Identificador del elemento versionado',
  `cVersion` varchar(12) NOT NULL COMMENT 'Numero de version N.NN.NN-XXXX',
  `cUpdated` datetime NOT NULL COMMENT 'Fecha de actualizacion',
  PRIMARY KEY (`cId`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `tversion`
--

LOCK TABLES `tversion` WRITE;
/*!40000 ALTER TABLE `tversion` DISABLE KEYS */;
INSERT INTO `tversion` VALUES (1,'DBT','1.2.23','2016-01-28 22:47:08');
/*!40000 ALTER TABLE `tversion` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Temporary view structure for view `vuser`
--

DROP TABLE IF EXISTS `vuser`;
/*!50001 DROP VIEW IF EXISTS `vuser`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE VIEW `vuser` AS SELECT 
 1 AS `cId`,
 1 AS `cMail`,
 1 AS `cName`*/;
SET character_set_client = @saved_cs_client;

--
-- Dumping routines for database 'ossa'
--
/*!50003 DROP FUNCTION IF EXISTS `fAppendComment` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fAppendComment`(vComment VARCHAR(120), vText VARCHAR(120)) RETURNS char(120) CHARSET utf8
BEGIN
	DECLARE vOut VARCHAR(120) DEFAULT '';

	IF(LENGTH(vComment)>0) THEN
		SET vOut = CONCAT(vComment, ', ', vText);
	ELSE
		SET vOut = vText;
	END IF;
		
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fBothMarks` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fBothMarks`() RETURNS bit(1)
BEGIN
	DECLARE vOut BIT DEFAULT FALSE;
	
	SELECT	TRUE INTO vOut 
	FROM	tParameter 
	WHERE	cKey='BOTH_MARKS' AND cValue = 'true';
	
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fCheckOutFriday` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fCheckOutFriday`() RETURNS char(5) CHARSET utf8
BEGIN
	RETURN '16:00';
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fCheckOutFriday2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fCheckOutFriday2`() RETURNS char(5) CHARSET utf8
BEGIN
	RETURN '16:00';
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fDate2DateTime` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fDate2DateTime`(vDate DATE, vHour INTEGER, vMinute INTEGER, vSecond INTEGER) RETURNS datetime
BEGIN
	DECLARE vOut DATETIME;
	SET vOut = fToDateTime(YEAR(vDate), MONTH(vDate), DAY(vDate), vHour, vMinute, vSecond);
	RETURN vOut;	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fDayOfWeek` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fDayOfWeek`(vMarkTime DATETIME) RETURNS char(10) CHARSET utf8
BEGIN 
	DECLARE vOut CHAR(10) DEFAULT '';
	
	CASE DAYOFWEEK(vMarkTime)
		WHEN 1 THEN SET vOut = 'Domingo';
		WHEN 2 THEN SET vOut = 'Lunes';
		WHEN 3 THEN SET vOut = 'Martes';
		WHEN 4 THEN SET vOut = 'Miercoles';
		WHEN 5 THEN SET vOut = 'Jueves';
		WHEN 6 THEN SET vOut = 'Viernes';
		WHEN 7 THEN SET vOut = 'Sabado';
		ELSE SET vOut = '';
	END CASE;
	
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fDayOfWeek2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fDayOfWeek2`(vMarkTime DATETIME) RETURNS char(10) CHARSET utf8
BEGIN 
	DECLARE vOut CHAR(10) DEFAULT '';
	
	CASE DAYOFWEEK(vMarkTime)
		WHEN 1 THEN SET vOut = 'Domingo';
		WHEN 2 THEN SET vOut = 'Lunes';
		WHEN 3 THEN SET vOut = 'Martes';
		WHEN 4 THEN SET vOut = 'Miercoles';
		WHEN 5 THEN SET vOut = 'Jueves';
		WHEN 6 THEN SET vOut = 'Viernes';
		WHEN 7 THEN SET vOut = 'Sabado';
		ELSE SET vOut = '';
	END CASE;
	
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fDayOfWeek3` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fDayOfWeek3`(vMarkTime DATE) RETURNS char(10) CHARSET utf8
BEGIN 
	DECLARE vOut CHAR(10) DEFAULT '';
	
	CASE DAYOFWEEK(vMarkTime)
		WHEN 1 THEN SET vOut = 'Domingo';
		WHEN 2 THEN SET vOut = 'Lunes';
		WHEN 3 THEN SET vOut = 'Martes';
		WHEN 4 THEN SET vOut = 'Miercoles';
		WHEN 5 THEN SET vOut = 'Jueves';
		WHEN 6 THEN SET vOut = 'Viernes';
		WHEN 7 THEN SET vOut = 'Sabado';
		ELSE SET vOut = '';
	END CASE;
	
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fEndDiffInSelect` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fEndDiffInSelect`(vEndDiffI INTEGER, vStartMark TIMESTAMP, vEndMark TIMESTAMP) RETURNS char(20) CHARSET utf8
BEGIN
	DECLARE vOut VARCHAR(20) DEFAULT '';

	IF(NOT vEndMark IS NULL) THEN
		IF(vStartMark IS NULL) THEN
			SET vOut = CONCAT('(', vEndDiffI, ')');
		ELSE
			SET vOut = vEndDiffI;
		END IF;
	END IF;
	
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fEndMark` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fEndMark`(	vEmployeeKey VARCHAR(20), vStartMark TIMESTAMP, 
							vHoursWorkday INTEGER, vCurrent DATE, vTolerance INTEGER,
							vBusinessDay BOOLEAN, vTurnDayId BIGINT(20)) RETURNS timestamp
BEGIN
	DECLARE vOut TIMESTAMP;
	DECLARE vEndTime TIMESTAMP;
		
	IF(vStartMark IS NULL) THEN
		IF (vBusinessDay) THEN
			SET vEndTime = CONCAT(vCurrent, ' ', (SELECT cEndTime FROM tTurnDay WHERE cId = vTurnDayId));
			SET vOut = fGetRealMark3(vEmployeeKey, vTolerance, vEndTime, 4);
		ELSE
			SET vOut = fFindMarkOnDay(vEmployeeKey, vCurrent, 4);
		END IF;
	ELSE
		SELECT cDate INTO vOut
		FROM tAttendanceLog 
		WHERE cEmployeeKey = vEmployeeKey AND 
			cDate BETWEEN vStartMark AND TIMESTAMPADD(HOUR, vHoursWorkday, vStartMark) AND
			cMarkType=4 
		ORDER BY cDate DESC LIMIT 1;
	END IF;

	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fEndTime` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fEndTime`(	vEndMark TIMESTAMP, vStartMark TIMESTAMP,
							vBusinessDay BOOLEAN, vTurnDayId BIGINT(20)) RETURNS timestamp
BEGIN
	DECLARE vOut TIMESTAMP;

	IF(vBusinessDay) THEN
		SET vOut = CONCAT(DATE(vEndMark), ' ', (SELECT cEndTime FROM tTurnDay WHERE cId = vTurnDayId));
	ELSE
		SET vOut = vStartMark;
	END IF;


	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fEndTime2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fEndTime2`(vMarkTime DATETIME, vUserId INT, vType CHAR(1)) RETURNS char(8) CHARSET utf8
BEGIN
	RETURN fGetLimitTime2(vMarkTime, vUserId, vType, 4);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fExtraTime` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fExtraTime`(vMark DATETIME, vLimitTime CHAR(8), vStart BOOLEAN) RETURNS char(100) CHARSET utf8
BEGIN
	DECLARE vOut CHAR(100) DEFAULT '';
	DECLARE vMinutes INTEGER DEFAULT 0;
	
	SET vMinutes = fExtraTimeAsMins(vMark, vLimitTime, vStart);
	
	IF(vMinutes != 0) THEN
		SET vOut = TIMESTAMPADD(MINUTE, vMinutes, MAKETIME(0,0,0));
	END IF;
	
	RETURN vOut;
	
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fExtraTime2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fExtraTime2`(vMark DATETIME, vLimitTime CHAR(8), vStart BOOLEAN) RETURNS char(100) CHARSET utf8
BEGIN
	DECLARE vOut CHAR(100) DEFAULT '';
	DECLARE vMinutes INTEGER DEFAULT 0;
	
	SET vMinutes = fExtraTimeAsMins2(vMark, vLimitTime, vStart);
	
	IF(vMinutes != 0) THEN
		SET vOut = TIMESTAMPADD(MINUTE, vMinutes, MAKETIME(0,0,0));
	END IF;

	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fExtraTime3` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fExtraTime3`(vMinutes INTEGER) RETURNS varchar(10) CHARSET utf8
BEGIN
	DECLARE vOut VARCHAR(10) DEFAULT '';
	
	SET vOut = TIMESTAMPADD(MINUTE, vMinutes, MAKETIME(0,0,0));

	RETURN vOut;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fExtraTimeAsMins` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fExtraTimeAsMins`(vMark DATETIME, vLimitTime CHAR(8), vStart BOOLEAN) RETURNS int(11)
BEGIN
	DECLARE vOut INTEGER DEFAULT 0;
	DECLARE vDateMarkAsString CHAR(100) DEFAULT '';
	DECLARE vDateMark DATETIME;
	
	IF(CHAR_LENGTH(vLimitTime)>0) THEN
		SET vDateMarkAsString = concat(DATE_FORMAT(vMark, '%Y-%m-%d'), ' ', vLimitTime);
		SET vDateMark = STR_TO_DATE(vDateMarkAsString, '%Y-%m-%d %H:%i:%S');

		IF(EXTRACT(HOUR FROM vMark)=23 AND vLimitTime='00:00:00') THEN
			SET vDateMark = TIMESTAMPADD(DAY, 1, vDateMark);
		END IF;
		
		IF(vStart) THEN
			SET vOut = TIMESTAMPDIFF(MINUTE, vMark, vDateMark);
		ELSE
			SET vOut = TIMESTAMPDIFF(MINUTE, vDateMark, vMark);
		END IF;

	END IF;

	
	
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fExtraTimeAsMins2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fExtraTimeAsMins2`(vMark DATETIME, vLimitTime CHAR(8), vStart BOOLEAN) RETURNS int(11)
BEGIN
	DECLARE vOut INTEGER DEFAULT 0;
	DECLARE vDateMarkAsString CHAR(100) DEFAULT '';
	DECLARE vDateMark DATETIME;
	
	IF(CHAR_LENGTH(vLimitTime)>0) THEN
		SET vDateMarkAsString = concat(DATE_FORMAT(vMark, '%Y-%m-%d'), ' ', vLimitTime);
		SET vDateMark = STR_TO_DATE(vDateMarkAsString, '%Y-%m-%d %H:%i:%S');

		IF(EXTRACT(HOUR FROM vMark)=23 AND vLimitTime='00:00:00') THEN
			SET vDateMark = TIMESTAMPADD(DAY, 1, vDateMark);
		END IF;
		
		IF(vStart) THEN
			SET vOut = TIMESTAMPDIFF(MINUTE, vMark, vDateMark);
		ELSE
			SET vOut = TIMESTAMPDIFF(MINUTE, vDateMark, vMark);
		END IF;

	END IF;
	
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fExtraTimeAsMins3` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fExtraTimeAsMins3`(vMark TIMESTAMP, vLimitTime TIMESTAMP, vStart BOOLEAN) RETURNS int(11)
BEGIN
	DECLARE vOut INTEGER DEFAULT 0;
	
	
	
	IF(vStart) THEN
		SET vOut = TIMESTAMPDIFF(MINUTE, vMark, vLimitTime);
	ELSE
		SET vOut = TIMESTAMPDIFF(MINUTE, vLimitTime, vMark);
	END IF;	
	RETURN vOut;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fExtraTimeAsMins4` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fExtraTimeAsMins4`(vMark TIMESTAMP, vLimitTime VARCHAR(8), vStart BOOLEAN, vCurrent DATE) RETURNS int(11)
BEGIN
	DECLARE vOut INTEGER DEFAULT 0; 
	DECLARE vDateMarkAsString VARCHAR(100) DEFAULT '';
	DECLARE vDateMark datetime;
	
	IF(CHAR_LENGTH(vLimitTime)>0) THEN

		SET vDateMarkAsString = CONCAT(DATE_FORMAT(vCurrent, '%Y-%m-%d'), ' ', vLimitTime);


		SET vDateMark = STR_TO_DATE(vDateMarkAsString, '%Y-%m-%d %H:%i:%s');
		
		IF(EXTRACT(HOUR FROM vMark)=23 AND vLimitTime='00:00:00') THEN
			SET vDateMark = TIMESTAMPADD(DAY, 1, vDateMark);
		END IF;
		
		IF(vStart) THEN
			SET vOut = TIMESTAMPDIFF(MINUTE, vMark, vDateMark);
		ELSE
			SET vOut = TIMESTAMPDIFF(MINUTE, vDateMark, vMark);
		END IF;

	END IF;

	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fExtraTimeAsMins5` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fExtraTimeAsMins5`(vFrom TIMESTAMP, vTo TIMESTAMP, vStart BOOLEAN) RETURNS int(11)
BEGIN
	DECLARE vOut INTEGER DEFAULT 0;
	DECLARE vDiff DECIMAL(8,3);
	IF(vStart) THEN
		SET vDiff = TIMESTAMPDIFF(SECOND, vFrom, vTo)/60;
	ELSE
		SET vDiff = TIMESTAMPDIFF(SECOND, vTo, vFrom)/60;
	END IF;
	SET vOut := ROUND(vDiff);
	
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fExtraTimeAsMins6` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fExtraTimeAsMins6`(vMark TIMESTAMP, vTime TIMESTAMP, vStart BOOLEAN, vTurnDayId BIGINT(20)) RETURNS int(11)
BEGIN
	DECLARE vOut			INTEGER DEFAULT 0;
	DECLARE vDiff			DECIMAL(8,3);
	
	DECLARE vInRange		BIT;
	
	
	
	SET vInRange = fInRange(vMark, vTime, vStart, vTurnDayId);
	IF(vInRange) THEN

		SET vOut = 0;
	ELSE
		IF(vStart) THEN
			SET vDiff = TIMESTAMPDIFF(SECOND, vMark, vTime)/60;
		ELSE
			SET vDiff = TIMESTAMPDIFF(SECOND, vTime, vMark)/60;
		END IF;
		SET vOut := ROUND(vDiff);
	END IF;
	
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fFindMarkOnDay` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fFindMarkOnDay`(vPersonKey VARCHAR(25), vCurrent DATE, vMarkType INTEGER) RETURNS timestamp
BEGIN
	DECLARE vOut TIMESTAMP;

	DECLARE vStart TIME;
	DECLARE vEnd TIME;
	
	SET vStart = MAKETIME(0,0,0);
	SET vEnd = MAKETIME(23,59,59);
	
	SELECT	cDate INTO vOut
	FROM	tAttendanceLog 
	WHERE	cEmployeeKey = vPersonKey AND 
			DATE(cDate) = DATE(vCurrent) AND 
			TIME(cDate) BETWEEN vStart AND vEnd
			AND cMarkType=vMarkType
	LIMIT 1;

	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fFindTurn` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fFindTurn`(vTurn BIGINT(20), vMark TIMESTAMP) RETURNS bigint(20)
BEGIN
	DECLARE vOut BIGINT(20);
	DECLARE vId BIGINT(20);
	
	DECLARE vTime TIME DEFAULT '00:00';
	DECLARE vDone BOOLEAN DEFAULT FALSE;
	DECLARE vTolerance INTEGER;
	DECLARE vTemp VARCHAR(20);
	DECLARE vStartRange TIMESTAMP;
	DECLARE vEndRange TIMESTAMP;
	
	DECLARE cursorHorary CURSOR FOR
		SELECT cId, cStartTime FROM tTurnDay WHERE cTurn = vTurn ORDER BY cStartTime;

	DECLARE CONTINUE HANDLER FOR NOT FOUND SET vDone = TRUE;
	
	OPEN cursorHorary;
	cursorHorary_loop: LOOP
		FETCH cursorHorary INTO vId, vTime;

    	IF(vDone) THEN 
			LEAVE cursorHorary_loop;
		END IF;

		SET vTolerance = fGetTolerance();
		
		SET vTemp = DATE_FORMAT(vMark, CONCAT('%Y-%m-%d ', vTime));
		
		IF(HOUR(vTime)=0 AND (HOUR(vMark) >= 24-(vTolerance/60) )) THEN
			SET vTemp = TIMESTAMPADD(DAY, 1, vTemp);
		END IF;
		
		SET vStartRange = TIMESTAMPADD(MINUTE, vTolerance * -1, vTemp);
		SET vEndRange = TIMESTAMPADD(MINUTE, vTolerance, vTemp);
		
		IF(vMark > vStartRange AND vMark < vEndRange) THEN
			SET vOut := vId;
		END IF;



    	IF(NOT vOut IS NULL) THEN 
			LEAVE cursorHorary_loop;
		END IF;
		
	END LOOP cursorHorary_loop;
	CLOSE cursorHorary;

	RETURN vOut;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fGetBusinessDay` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fGetBusinessDay`(vEmployeeId BIGINT(20), vEmployeeKey VARCHAR(20), 
								vTolerance INTEGER, vDate DATE) RETURNS tinyint(1)
BEGIN 
	DECLARE vOut		BOOLEAN DEFAULT NULL;
	DECLARE vTurnDayId	BIGINT(20);
	DECLARE vStartMark	TIMESTAMP;
	
	IF(fIsFlexible(vDate, vEmployeeId)) THEN
		SET vStartMark = fStartMark(vEmployeeKey, vTolerance, vDate, NULL, TRUE, NULL);

		SET vTurnDayId = fMarkAndUserToTurnDayId4(vDate, vEmployeeId, vTolerance, TRUE);
		SET vOut =  (SELECT cBusinessDay FROM tTurnDay WHERE cId = vTurnDayId);
	ELSE
		SET vTurnDayId = fMarkAndUserToTurnDayId4(vDate, vEmployeeId, vTolerance, FALSE);
		SET vOut =  (SELECT cBusinessDay FROM tTurnDay WHERE cId = vTurnDayId);

	END IF;
					
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fGetComment3` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fGetComment3`(vMark DATETIME, vEmployeeId BIGINT(20), vTurnDayId BIGINT(20), vBusinessDay BOOLEAN, 
							vStartMark DATETIME, vEndMark DATETIME) RETURNS char(120) CHARSET utf8
BEGIN
	DECLARE vOut VARCHAR(120) DEFAULT '';
	DECLARE vReason VARCHAR(50);

	SELECT tLicenseCause.cName INTO vOut 
	FROM tLicense 
	LEFT JOIN tLicenseCause ON tLicense.cLicenseCause = tLicenseCause.cId 
	WHERE	cEmployee = vEmployeeId AND 
			DATE(vMark) BETWEEN cStartDate AND cEndDate
	LIMIT 1;

	IF(EXISTS(SELECT cId FROM tFiscalDate WHERE cDate = DATE(vMark))) THEN
		SELECT cReason INTO vReason FROM tFiscalDate WHERE cDate = DATE(vMark) LIMIT 1;
		SET vOut = fAppendComment(vOut, vReason);
	END IF;
	
	IF(vStartMark IS NULL AND vEndMark IS NULL) THEN
		IF(vBusinessDay = TRUE) THEN
			IF (LENGTH(vOut)=0) THEN
				SET vOut = fAppendComment(vOut, 'Sin marcas');
			END IF;			
		END IF;			
	ELSEIF(vStartMark IS NULL) THEN
		SET vOut = fAppendComment(vOut, 'Sin entrada');
	ELSEIF(vEndMark IS NULL) THEN
		SET vOut = fAppendComment(vOut, 'Sin salida');
	END IF;

	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fGetHoursWorkday` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fGetHoursWorkday`() RETURNS int(11)
BEGIN
	DECLARE vOut INTEGER DEFAULT 12;
	
	IF(EXISTS(SELECT cValue FROM tParameter WHERE cKey='HOURS_WORKDAY')) THEN
		SELECT cValue INTO vOut FROM tParameter WHERE cKey='HOURS_WORKDAY' LIMIT 1;
	END IF;

	RETURN vOut;	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fGetLicenseCause` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fGetLicenseCause`(vDate DATE, vEmployeeId BIGINT(20)) RETURNS char(30) CHARSET utf8
BEGIN
	DECLARE vOut VARCHAR(120) DEFAULT 'Sin Justificar';
 
 	SELECT tLicenseCause.cName INTO vOut 
	FROM tLicense 
	LEFT JOIN tLicenseCause ON tLicense.cLicenseCause = tLicenseCause.cId 
	WHERE	cEmployee = vEmployeeId AND 
			vDate BETWEEN cStartDate AND cEndDate
	LIMIT 1;
 
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fGetLimitTime2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fGetLimitTime2`(vMarkTime DATETIME, vUserId BIGINT(20), vTypeAsNum INT, vExpectedType INT) RETURNS char(8) CHARSET utf8
BEGIN
	DECLARE vOut CHAR(8) DEFAULT '';
	DECLARE vTurnDayId BIGINT(20);
	DECLARE vTurnDay BIGINT(20);
	DECLARE vDaysCount INTEGER;
	
	DECLARE vRTurno BIGINT(20);
	DECLARE vStart DATE;
	DECLARE vEnd DATE;
	DECLARE vDaysOfTurn INTEGER;

	SET vTurnDayId = fMarkAndUserToTurnDayId2(vMarkTime, vUserId);
	
	
	
	IF(vTypeAsNum = 1 AND vExpectedType = 1) THEN
		IF(vTurnDay IS NULL) THEN
			SET vOut = fInferTime2(vMarkTime);
		ELSE
			SELECT cStartTime INTO vOut 
			FROM tTurnDay 
			WHERE cId = vTurnDayId;
		END IF;
	END IF;

	
	IF(vTypeAsNum = 4 AND vExpectedType = 4) THEN
		IF(vTurnDay IS NULL) THEN
			SET vOut = fInferTime2(vMarkTime);
		ELSE
			SELECT cEndTime INTO vOut 
			FROM tTurnDay 
			WHERE cId = vTurnDayId;
		END IF;
	END IF;

	

	
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fGetMarkTime` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fGetMarkTime`(vType CHAR, vDateTime DATETIME, vExpected INT) RETURNS char(8) CHARSET utf8
BEGIN
	DECLARE vOut CHAR(8) DEFAULT '';
	DECLARE vTypeAsNum INT DEFAULT 0;  

	SET vTypeAsNum = fSolveTypeAsNum(vType);

	IF(vTypeAsNum = vExpected) THEN

		SET vOut = TIME(vDateTime);
	END IF;
	

	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fGetMarkTime2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fGetMarkTime2`(vTypeAsNum INTEGER, vDateTime DATETIME, vExpected INT) RETURNS char(8) CHARSET utf8
BEGIN
	DECLARE vOut CHAR(8) DEFAULT '';
	
	IF(vTypeAsNum = vExpected) THEN
		SET vOut = TIME(vDateTime);
	END IF;

	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fGetRealMark3` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fGetRealMark3`(vPersonKey VARCHAR(25), vMinutes INTEGER, vTime TIMESTAMP, vMarkType INTEGER) RETURNS timestamp
BEGIN
	DECLARE vOut TIMESTAMP;

	SELECT cDate INTO vOut
	FROM tAttendanceLog 
	WHERE	cEmployeeKey = vPersonKey AND 
			cDate BETWEEN	TIMESTAMPADD(MINUTE, (vMinutes*-1), vTime) AND 
							TIMESTAMPADD(MINUTE, vMinutes, vTime) AND
			cMarkType = vMarkType
	LIMIT 1;

	RETURN vOut;	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fGetTolerance` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fGetTolerance`() RETURNS int(11)
BEGIN
	DECLARE vOut INTEGER DEFAULT 120;
	IF (EXISTS(SELECT cId FROM tParameter WHERE cKey='TOLERANCE_INFERENCE')) THEN
		SELECT cValue INTO vOut FROM tParameter WHERE cKey='TOLERANCE_INFERENCE';
	END IF;
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fHaveLicense` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fHaveLicense`(vMarkTime DATE, vEmployeeId BIGINT(20)) RETURNS bit(1)
BEGIN
	DECLARE vOut BIT DEFAULT FALSE;
	
	SELECT	TRUE INTO vOut 
	FROM	tLicense
	WHERE	cEmployee = vEmployeeId AND 
			DATE(vMarkTime) BETWEEN DATE(cStartDate) AND DATE(cEndDate)
	LIMIT 1;
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fInferTime` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fInferTime`(vMarkTime DATETIME) RETURNS timestamp
BEGIN
	DECLARE vOut TIMESTAMP DEFAULT NULL;
	DECLARE vTime TIME DEFAULT '00:00:00';
	DECLARE vDone BOOLEAN DEFAULT FALSE;
	DECLARE cursorHorary CURSOR FOR
		SELECT cValue FROM tParameter WHERE cKey LIKE 'INFER_TIME%' ORDER BY cKey;

	DECLARE CONTINUE HANDLER FOR NOT FOUND SET vDone = TRUE;
	
	OPEN cursorHorary;
	cursorHorary_loop: LOOP
		FETCH cursorHorary INTO vTime;

    	IF(vDone) THEN 
			LEAVE cursorHorary_loop;
		END IF;

		SET vOut = fResolveTime(vTime, vMarkTime);

    	IF(NOT vOut IS NULL) THEN 
			LEAVE cursorHorary_loop;
		END IF;
		
		
	END LOOP cursorHorary_loop;
	CLOSE cursorHorary;

	RETURN vOut;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fInferTime2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fInferTime2`(vMarkTime DATETIME) RETURNS char(8) CHARSET utf8
BEGIN
	
	DECLARE vTime1 TIME DEFAULT '00:00:00';
	DECLARE vTime2 TIME DEFAULT '08:00:00';
	DECLARE vTime3 TIME DEFAULT '16:00:00';
	DECLARE vTime4 TIME DEFAULT '20:00:00';
	DECLARE vOut CHAR(10) DEFAULT '';
	
	SET vOut = fResolveTime2(vTime1, vMarkTime);
	
	IF(LENGTH(vOut) = 0) THEN
		SET vOut = fResolveTime2(vTime2, vMarkTime);
		IF(LENGTH(vOut) = 0) THEN
			SET vOut = fResolveTime2(vTime3, vMarkTime);
			IF(LENGTH(vOut) = 0) THEN
				SET vOut = fResolveTime2(vTime4, vMarkTime);
			END IF;
		END IF;
	END IF;
	
	RETURN vOut;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fInRange` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fInRange`(vMark TIMESTAMP, vTime TIMESTAMP, vStart BOOLEAN, vTurnDayId BIGINT(20)) RETURNS bit(1)
BEGIN
	DECLARE vOut			BIT;
	DECLARE vEdgePrevIn		INTEGER;
	DECLARE vEdgePostIn		INTEGER;
	DECLARE vEdgePrevOut	INTEGER;
	DECLARE vEdgePostOut	INTEGER;
	DECLARE vStartRange		TIMESTAMP;
	DECLARE vEndRange		TIMESTAMP;

	SELECT cEdgePrevIn, cEdgePostIn, cEdgePrevOut, cEdgePostOut
	INTO vEdgePrevIn, vEdgePostIn, vEdgePrevOut, vEdgePostOut
	FROM tTurnDay WHERE cId = vTurnDayId;
	
	IF(vStart) THEN
		SET vStartRange	= TIMESTAMPADD(MINUTE, vEdgePrevIn, vTime);
		SET vEndRange	= TIMESTAMPADD(MINUTE, vEdgePostIn, vTime);
	ELSE
		SET vStartRange	= TIMESTAMPADD(MINUTE, vEdgePrevOut, vTime);
		SET vEndRange	= TIMESTAMPADD(MINUTE, vEdgePostOut, vTime);
	END IF;
	
	IF(vMark > vStartRange AND vMark < vEndRange) THEN
		SET vOut = TRUE;
	ELSE
		SET vOut = FALSE;
	END IF;
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fIsBusinessDay` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fIsBusinessDay`(vTurnDayId BIGINT(20)) RETURNS tinyint(1)
BEGIN
	DECLARE vOut BOOLEAN;
	SELECT cBusinessDay INTO vOut FROM tTurnDay WHERE cId = vTurnDayId;
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fIsFlexible` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fIsFlexible`(vMarkTime DATE, vEmployeeId BIGINT(20)) RETURNS tinyint(1)
BEGIN 
	DECLARE vOut BOOLEAN DEFAULT NULL;
	DECLARE vRTurn BIGINT(20);
	DECLARE vTurnDay BIGINT(20);
	DECLARE vTurn BIGINT(20);

	SELECT cId INTO vRTurn
	FROM tR_EmployeeTurn 
	WHERE cEmployee = vEmployeeId AND vMarkTime BETWEEN cStartDate AND cEndDate
	LIMIT 1;
	
	SELECT cTurn INTO vTurn
	FROM tR_EmployeeTurn
	WHERE cId = vRTurn;
	
	SELECT cFlexible INTO vOut
	FROM tTurn
	WHERE cId = vTurn;
		
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fIsHoliday` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fIsHoliday`(vCurrent DATE) RETURNS tinyint(1)
BEGIN
	DECLARE vOut BOOLEAN;
	DECLARE vDayOfWeek	INTEGER;
	SET vDayOfWeek := DAYOFWEEK(vCurrent);
	SET vOut := EXISTS(SELECT cId FROM tFiscalDate WHERE cDate = DATE(vCurrent)) OR vDayOfWeek=1 OR vDayOfWeek=7;
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fLuchTime` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fLuchTime`(pType CHAR, vDateTime DATETIME) RETURNS char(20) CHARSET utf8
BEGIN
	DECLARE vOut CHAR(20) DEFAULT '';
	DECLARE vType INT DEFAULT 0;
	
	SET vType = fSolveTypeAsNum(pType); 

	IF (vType=2 OR vType=3) THEN
			SET vOut = fTimeFormat(vDateTime);

	END IF;
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fLuchTime2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fLuchTime2`(pType CHAR, vDateTime DATETIME) RETURNS char(20) CHARSET utf8
BEGIN
	DECLARE vOut CHAR(20) DEFAULT '';
	
	IF (pType=2 OR pType=3) THEN
			SET vOut = fTimeFormat2(vDateTime);
	END IF;
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fLunchMark` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fLunchMark`(vEmployeeKey VARCHAR(20), vStartMark TIMESTAMP, vHoursWorkday INTEGER) RETURNS timestamp
BEGIN
	DECLARE vOut TIMESTAMP;
	
	SELECT cDate INTO vOut
	FROM tAttendanceLog 
	WHERE cEmployeeKey = vEmployeeKey AND 
		cDate BETWEEN vStartMark AND TIMESTAMPADD(HOUR, vHoursWorkday, vStartMark) AND
		cMarkType=2 
	LIMIT 1	;
			
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fMarkAndUserToTurnDayId4` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fMarkAndUserToTurnDayId4`(vMarkTime DATETIME, vEmployeeId BIGINT(20), 
						vTolerance INTEGER, vFlexible BOOLEAN) RETURNS bigint(20)
BEGIN 
	DECLARE vOut BIGINT(20) DEFAULT NULL;
	DECLARE vStart DATE;
	DECLARE vEnd DATE;
	DECLARE vDaysCount INTEGER;
	DECLARE vDaysOfTurn INTEGER;
	DECLARE vTurnDay BIGINT(20);
	DECLARE vTurn BIGINT(20);

	IF(NOT vFlexible IS NULL) THEN
		IF(vFlexible) THEN
			SET vOut := fFindTurn(vTurn, vMarkTime);
		ELSE
			SELECT cStartDate, cEndDate, cTurn INTO vStart, vEnd, vTurn
			FROM tR_EmployeeTurn
			WHERE	cEmployee = vEmployeeId 
					AND DATE(vMarkTime) BETWEEN cStartDate AND cEndDate
					AND cException = TRUE
			LIMIT 1;
			
			IF(vTurn IS NULL) THEN
				SELECT cStartDate, cEndDate, cTurn INTO vStart, vEnd, vTurn
				FROM tR_EmployeeTurn
				WHERE cEmployee = vEmployeeId 
					AND DATE(vMarkTime) BETWEEN cStartDate AND cEndDate
					AND cException = FALSE
				LIMIT 1;
			END IF;
			
			SELECT MAX(cDay) INTO vDaysOfTurn 
			FROM tTurnDay
			WHERE cTurn = vTurn;
			
			SET vDaysCount = DATEDIFF(vMarkTime, vStart) % vDaysOfTurn;
			SET vDaysCount = vDaysCount + 1;
			
			SELECT cId INTO vOut 
			FROM tTurnDay 
			WHERE cTurn = vTurn AND cDay = vDaysCount;
		END IF;
	END IF;

	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fMarkInTime` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fMarkInTime`(vType CHAR, vDateTime DATETIME) RETURNS char(8) CHARSET utf8
BEGIN
	RETURN fGetMarkTime(vType, vDateTime, 1);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fMarkInTime2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fMarkInTime2`(vType INTEGER, vDateTime DATETIME) RETURNS char(8) CHARSET utf8
BEGIN
	RETURN fGetMarkTime2(vType, vDateTime, 1);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fMarkOutTime` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fMarkOutTime`(vType CHAR, vDateTime DATETIME) RETURNS char(8) CHARSET utf8
BEGIN
	RETURN fGetMarkTime(vType, vDateTime, 4);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fMarkOutTime2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fMarkOutTime2`(vType INTEGER, vDateTime DATETIME) RETURNS char(8) CHARSET utf8
BEGIN
	RETURN fGetMarkTime2(vType, vDateTime, 4);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fResolveTime` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fResolveTime`(vTime TIME, vMarkTime DATETIME) RETURNS datetime
BEGIN
	DECLARE vOut DATETIME DEFAULT NULL;
	DECLARE vStartRange DATETIME;
	DECLARE	vEndRange DATETIME;
	DECLARE vTemp CHAR(100);
	DECLARE vTolerance INTEGER;

	SET vTolerance = fGetTolerance();
	
	SET vTemp = DATE_FORMAT(vMarkTime, CONCAT('%Y-%m-%d ', vTime));
	
	IF(HOUR(vTime)=0 AND (HOUR(vMarkTime) >= 24-(vTolerance/60) )) THEN
		SET vTemp = TIMESTAMPADD(DAY, 1, vTemp);
	END IF;
	
	SET vStartRange = TIMESTAMPADD(MINUTE, vTolerance * -1, vTemp);
	SET vEndRange = TIMESTAMPADD(MINUTE, vTolerance, vTemp);
	
	IF(vMarkTime > vStartRange AND vMarkTime < vEndRange) THEN
		SET vOut := DATE_FORMAT(vTemp, CONCAT('%Y-%m-%d ', vTime));
	END IF;
	
	RETURN vOut;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fResolveTime2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fResolveTime2`(vTime TIME, vMarkTime DATETIME) RETURNS char(100) CHARSET utf8
BEGIN

	DECLARE vOut CHAR(100) DEFAULT '';
	DECLARE vStartRange DATETIME;
	DECLARE	vEndRange DATETIME;
	DECLARE vTemp CHAR(100);
	
	SET vTemp = DATE_FORMAT(vMarkTime, concat('%Y-%m-%d ', vTime));
	IF(HOUR(vMarkTime)=23) THEN
		SET vTemp = TIMESTAMPADD(DAY, 1, vTemp);
	END IF;

	SET vStartRange = TIMESTAMPADD(HOUR, -1, vTemp);
	SET vEndRange = TIMESTAMPADD(HOUR, 1, vTemp);
	
	

	


	IF(vMarkTime > vStartRange AND vMarkTime < vEndRange) THEN
		SET vOut = vTime;
	END IF;
	

	
	RETURN vOut;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fReturnMark` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fReturnMark`(vEmployeeKey VARCHAR(20), vStartMark TIMESTAMP, vHoursWorkday INTEGER, vLunchMark TIMESTAMP) RETURNS timestamp
BEGIN
	DECLARE vOut TIMESTAMP;
	SELECT cDate INTO vOut
	FROM tAttendanceLog 
	WHERE cEmployeeKey = vEmployeeKey AND 
		cDate BETWEEN vStartMark AND TIMESTAMPADD(HOUR, vHoursWorkday, vLunchMark) AND
		cMarkType=3 
	LIMIT 1;
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fSolveType` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fSolveType`(pType CHAR) RETURNS char(20) CHARSET utf8
BEGIN
	DECLARE vOut CHAR(20) DEFAULT '';
	
	CASE pType
		WHEN 'I' THEN SET vOut = 'Entrada';
		WHEN '0' THEN SET vOut = 'Colacion';
		WHEN '1' THEN SET vOut = 'Volver';
		WHEN 'O' THEN SET vOut = 'Salida';
		ELSE SET vOut = '';
	END CASE;
	
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fSolveType2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fSolveType2`(pType CHAR) RETURNS char(20) CHARSET utf8
BEGIN
	DECLARE vOut CHAR(20) DEFAULT '';
	
	CASE pType
		WHEN 'I' THEN SET vOut = 'Entrada';
		WHEN '0' THEN SET vOut = 'Colacion';
		WHEN '1' THEN SET vOut = 'Volver';
		WHEN 'O' THEN SET vOut = 'Salida';
		ELSE SET vOut = '';
	END CASE;
	
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fSolveTypeArea` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fSolveTypeArea`(pType CHAR(5)) RETURNS char(50) CHARSET utf8
BEGIN
	DECLARE vOut CHAR(50) DEFAULT '';
	
	CASE pType
		WHEN '1 ' THEN SET vOut = 'Enlasa';
		WHEN '2 ' THEN SET vOut = 'Teno';
		WHEN '3 ' THEN SET vOut = 'Trapen';
		WHEN '4 ' THEN SET vOut = 'Peñon';
		WHEN '5 ' THEN SET vOut = 'Diego';
		
		ELSE SET vOut = '';

	END CASE;
	
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fSolveTypeArea2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fSolveTypeArea2`(pType CHAR(5)) RETURNS char(50) CHARSET utf8
BEGIN
	DECLARE vOut CHAR(50) DEFAULT '';
	
	CASE pType
		WHEN '1 ' THEN SET vOut = 'Enlasa';
		WHEN '2 ' THEN SET vOut = 'Teno';
		WHEN '3 ' THEN SET vOut = 'Trapen';
		WHEN '4 ' THEN SET vOut = 'Peñon';
		WHEN '5 ' THEN SET vOut = 'Diego';
		
		ELSE SET vOut = '';

	END CASE;
	
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fSolveTypeAsNum` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fSolveTypeAsNum`(pType CHAR) RETURNS int(11)
BEGIN
	DECLARE vOut INT DEFAULT -1;
	
	CASE pType
		WHEN 'I' THEN SET vOut = 1;
		WHEN '0' THEN SET vOut = 2;
		WHEN '1' THEN SET vOut = 3;
		WHEN 'O' THEN SET vOut = 4;
		ELSE SET vOut = -1;
	END CASE;
	
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fSolveTypeTurno` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fSolveTypeTurno`(pType CHAR(20)) RETURNS char(50) CHARSET utf8
BEGIN
	DECLARE vOut CHAR(50) DEFAULT '';
	
	CASE pType
		WHEN 'Admin1' THEN SET vOut = '08:00 - 17:30';
		WHEN 'Admin2' THEN SET vOut = '08:45 - 18:15';
		WHEN 'Admin3' THEN SET vOut = '09:30 - 19:00';
		ELSE SET vOut = '';

	END CASE;
	
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fSolveTypeTurno2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fSolveTypeTurno2`(vUserId BIGINT(20), vMarkTime DATETIME) RETURNS char(50) CHARSET utf8
BEGIN
	DECLARE vOut CHAR(50) DEFAULT '';
	DECLARE vRTurno BIGINT(20);
	
	
	SET vRTurno = fGetJournal2(vUserId, vMarkTime);
	
	return vRTurno;
	
	SELECT CONCAT(cStartTime, ' - ', cEndTime) INTO vOut 
	FROM tTurnDay
	WHERE cTurn=vRTurno;
	
	
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fStartDiffInSelect` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fStartDiffInSelect`(vStartDiffI INTEGER, vStartMark TIMESTAMP, vEndMark TIMESTAMP) RETURNS char(20) CHARSET utf8
BEGIN
	DECLARE vOut VARCHAR(20) DEFAULT '';
	
	IF(NOT vStartMark IS NULL) THEN
		IF(vEndMark IS NULL) THEN
			SET vOut = CONCAT('(', vStartDiffI, ')');
		ELSE
			SET vOut = vStartDiffI;
		END IF;
	END IF;

	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fStartMark` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fStartMark`(	vEmployeeKey VARCHAR(20), vTolerance INTEGER, vCurrent DATE,
							vBusinessDay BOOLEAN, vFlexible BOOLEAN, vTurnDayId BIGINT(20)) RETURNS timestamp
BEGIN
	DECLARE vOut		TIMESTAMP DEFAULT NULL;
	DECLARE vMark		TIMESTAMP;
	DECLARE vStart		TIMESTAMP;
	DECLARE vEnd		TIMESTAMP;
	DECLARE vTime		VARCHAR(5);
	
	IF (vFlexible) THEN 
		SET vMark := fDate2DateTime(vCurrent, 0, 0, 0);
		SET vStart := TIMESTAMPADD(MINUTE, vTolerance * -1, vMark);
		SET vMark := fDate2DateTime(vCurrent, 23, 59, 59);
		SET vEnd := TIMESTAMPADD(MINUTE, vTolerance * -1, vMark);
		
		SELECT cDate INTO vOut
		FROM tAttendanceLog 
		WHERE cEmployeeKey = vEmployeeKey AND 
			cDate BETWEEN vStart AND vEnd AND
			cMarkType=1 
		ORDER BY cDate ASC 
		LIMIT 1;
		
	ELSE 
		IF(vBusinessDay) THEN
			SET vTime = (SELECT cStartTime FROM tTurnDay WHERE cId = vTurnDayId);
			
			SET vMark = CONCAT(vCurrent, ' ', vTime);
			
			SET vStart := TIMESTAMPADD(MINUTE, vTolerance * -1, vMark);
			SET vEnd := TIMESTAMPADD(MINUTE, vTolerance, vMark);
			SELECT cDate INTO vOut
					FROM tAttendanceLog 
					WHERE cEmployeeKey = vEmployeeKey AND 
						cDate BETWEEN vStart AND vEnd AND
			cMarkType=1
			ORDER BY cDate ASC
			LIMIT 1;
		ELSE
			SET vOut = fFindMarkOnDay(vEmployeeKey, vCurrent, 1);
		END IF;
	END IF;
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fStartTime` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fStartTime`(vStartMark TIMESTAMP, vBusinessDay BOOLEAN, vTurnDayId BIGINT(20)) RETURNS timestamp
BEGIN
	DECLARE vOut TIMESTAMP;
	DECLARE vTime VARCHAR(10);
	
	IF(vTurnDayId IS NULL) THEN
		SET vOut = fInferTime(vStartMark);
	ELSE
		IF(vBusinessDay) THEN
			SELECT cStartTime INTO vTime FROM tTurnDay WHERE cId = vTurnDayId;
			
			IF(TIME(vTime)=0 AND HOUR(vStartMark)>22) THEN
				SET vStartMark = TIMESTAMPADD(DAY, 1, vStartMark);
			END IF;
			
			SET vOut = CONCAT(DATE(vStartMark), ' ', vTime);
		ELSE
			SET vOut = vStartMark;
		END IF;
	END IF;
	
	RETURN vOut;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fStartTime2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fStartTime2`(vMarkTime DATETIME, vUserId BIGINT(20), vType CHAR(1)) RETURNS char(80) CHARSET utf8
BEGIN
	RETURN fGetLimitTime2(vMarkTime, vUserId, vType, 1);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fTimeFormat` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fTimeFormat`(vTime TIME) RETURNS char(8) CHARSET utf8
BEGIN
	RETURN vTime;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fTimeFormat2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fTimeFormat2`(vTime TIME) RETURNS char(8) CHARSET utf8
BEGIN
	RETURN vTime;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fToDateTime` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fToDateTime`(vYear INTEGER,
							vMonth INTEGER,
							vDay INTEGER,
							vHour INTEGER,
							vMinute INTEGER,
							vSecond INTEGER) RETURNS datetime
BEGIN
	DECLARE vOut DATETIME;
	SET vOut = DATE_FORMAT(
					CONCAT(CONCAT_WS('-', vYear, vMonth, vDay), ' ', CONCAT_WS(':', vHour, vMinute, vSecond)),
					'%Y-%m-%d %H:%i:%s'
					);
	RETURN vOut;	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pAbsence` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pAbsence`(IN vDate DATE)
BEGIN	
	DECLARE vId		BIGINT(20);
	DECLARE vKey 	VARCHAR(15);
	DECLARE vDone BOOLEAN DEFAULT FALSE;
	DECLARE cursorEmployee CURSOR FOR
		SELECT	cId, cKey
		FROM	tEmployee;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET vDone = TRUE;
	
	DROP TEMPORARY TABLE IF EXISTS tEmployee_temp;
	
	CREATE TEMPORARY TABLE tEmployee_temp (
		idEmployee BIGINT(20)  NOT NULL
    )Engine=memory;
	
	OPEN cursorEmployee;
	cursorEmployee_loop: LOOP
		FETCH cursorEmployee INTO vId, vKey;
		
		IF(vDone) THEN 
			LEAVE cursorEmployee_loop;
		END IF;

		IF NOT EXISTS(SELECT cDate FROM tAttendanceLog WHERE vDate = DATE(cDate) AND cEmployeeKey = vKey) THEN 
		    INSERT INTO tEmployee_temp(idEmployee) VALUES(vId);
		END IF;
		
	END LOOP cursorEmployee_loop;
	CLOSE cursorEmployee;
	
	SELECT	a.cId			AS 'Id Empleado',
			a.cRut			AS 'RUT',
			a.cName			AS 'Nombre',
			c.cName			AS 'Cargo',
			b.cName			AS 'Area',
		IFNULL(	(SELECT CONCAT(cStartTime, ' A ', cEndTime) 
				FROM tTurnDay 
				WHERE cId = fMarkAndUserToTurnDayId4(vDate, a.cId, fGetTolerance(), fIsFlexible(vDate, a.cId))),'Sin Turno') AS 'Turno'
	FROM tEmployee AS a
	LEFT JOIN tArea AS b ON a.cArea = b.cId
	LEFT JOIN tPost AS c ON a.cPost = c.cId
	WHERE a.cId IN (SELECT idEmployee FROM tEmployee_temp)
	ORDER BY a.cName;
	
	DROP TEMPORARY TABLE IF EXISTS tEmployee_temp;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pAbsence2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pAbsence2`(IN vStartDate DATE, IN vEndDate DATE, IN vEmployees VARCHAR(3000))
BEGIN
	DECLARE vId		BIGINT(20);
	DECLARE vKey 	VARCHAR(15);
	DECLARE vCurrent	DATE;
	DECLARE vDone 		BOOLEAN DEFAULT FALSE;
	DECLARE vFlexible	BOOLEAN;
	DECLARE vBusinessDay	BOOLEAN;
	DECLARE vTolerance	INTEGER;
	DECLARE cursorEmployee CURSOR FOR
		SELECT	cId, cKey
		FROM	tEmployee;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET vDone = TRUE;
	
	DROP TEMPORARY TABLE IF EXISTS tEmployee_temp;
	
	SET vTolerance = fGetTolerance();
	
	CREATE TEMPORARY TABLE tEmployee_temp (
		idEmployee		BIGINT(20)  NOT NULL,
		absenceDate		DATE NOT NULL
    )Engine=memory;
	
	OPEN cursorEmployee;
	cursorEmployee_loop: LOOP
		FETCH cursorEmployee INTO vId, vKey;
		
		IF(vDone) THEN 
			LEAVE cursorEmployee_loop;
		END IF;


		
		SET vCurrent = vStartDate;
		WHILE vCurrent <= vEndDate DO
			
			IF NOT EXISTS(SELECT cId FROM tAttendanceLog WHERE DATE(vCurrent) = DATE(cDate) AND cEmployeeKey = vKey) THEN
				IF(NOT EXISTS(SELECT cId FROM tFiscalDate WHERE cDate = DATE(vCurrent))) THEN

					SET vFlexible = fIsFlexible(vCurrent, vId);

					SET vBusinessDay = fGetBusinessDay(vId, vKey, vTolerance, vCurrent);

					IF(vBusinessDay) THEN
						INSERT INTO tEmployee_temp(idEmployee, absenceDate) VALUES(vId, DATE(vCurrent));
					END IF;
				END IF;
			END IF;

			SET vCurrent = DATE_ADD(vCurrent, INTERVAL 1 DAY);
		END WHILE;
		
	END LOOP cursorEmployee_loop;
	CLOSE cursorEmployee;
	
	
	SET @vSQL = 'SELECT b.cId			AS Id, ';
	SET @vSQL = CONCAT(@vSQL, 'a.absenceDate	AS Fecha, ');
	SET @vSQL = CONCAT(@vSQL, 'b.cRut			AS Rut, ');
	SET @vSQL = CONCAT(@vSQL, 'b.cName			AS Nombre, ');
	SET @vSQL = CONCAT(@vSQL, 'c.cName			AS Cargo, ');
	SET @vSQL = CONCAT(@vSQL, 'd.cName			AS Area, ');
	SET @vSQL = CONCAT(@vSQL, 'fGetLicenseCause(a.absenceDate, b.cId) AS Causa ');
	SET @vSQL = CONCAT(@vSQL, 'FROM tEmployee_temp AS a ');
	SET @vSQL = CONCAT(@vSQL, 'LEFT JOIN tEmployee AS b ON a.idEmployee = b.cId ');
	SET @vSQL = CONCAT(@vSQL, 'LEFT JOIN tPost AS c ON b.cPost = c.cId ');
	SET @vSQL = CONCAT(@vSQL, 'LEFT JOIN tArea AS d ON b.cArea = d.cId ');
	SET @vSQL = CONCAT(@vSQL, 'WHERE b.cId IN (',vEmployees,') ');
	SET @vSQL = CONCAT(@vSQL, 'ORDER BY a.absenceDate, b.cName ; ');


		PREPARE smpt FROM @vSQL;
		EXECUTE smpt; 
		DEALLOCATE PREPARE smpt;
	
	
	DROP TEMPORARY TABLE IF EXISTS tEmployee_temp;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pAddReportProperty` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pAddReportProperty`(IN vKey VARCHAR(30), IN vName VARCHAR(100), IN vReportType BIGINT(20), IN vValue VARCHAR(255))
BEGIN
	DECLARE vId BIGINT(20);
	IF(EXISTS(SELECT cId  FROM tReportPropertyType WHERE cKey=vKey)) THEN
		SELECT cId INTO vId FROM tReportPropertyType WHERE cKey=vKey;
	ELSE
		INSERT INTO tReportPropertyType(cKey, cName) VALUES(vKey, vName);
		SET vId = LAST_INSERT_ID();
	END IF;


	
	INSERT INTO tR_ReportPropertyType_ReportType(cReportType, cReportPropertyType) VALUES(vReportType, vId);

	INSERT INTO tReportProperty(cPropertyType, cReport, cValue)	
		SELECT vId, cId, vValue FROM tReport WHERE cType = vReportType;
	

		
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pCrew` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pCrew`(IN vStartDate DATE, IN vEndDate DATE, IN vEmployees VARCHAR(2500))
BEGIN
	DECLARE vCurrent DATE;
	
	SET @vStartDate = vStartDate;
	SET @vEndDate = vEndDate;
	
	DROP TABLE IF EXISTS tCrewProcess_temp;
	CREATE TABLE IF NOT EXISTS tCrewProcess_temp(
		cId				BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
		cDate			DATE NOT NULL,
		cEmployee		BIGINT(20) NULL,
		cHoursWorked	DOUBLE DEFAULT '0',
		cWorked			BIT	DEFAULT 0,
		cHired			BIT DEFAULT 0
	) ENGINE=Memory;
	
	SET @vSQL = 'INSERT INTO tCrewProcess_temp(cDate, cEmployee, cHoursWorked, cWorked, cHired) ';
	SET @vSQL = CONCAT(@vSQL, 'SELECT cDate, cEmployee, cHoursWorked, cWorked, cHired ');
	SET @vSQL = CONCAT(@vSQL, 'FROM tCrewProcess ');
	SET @vSQL = CONCAT(@vSQL, 'WHERE DATE(cDate) BETWEEN ? AND ? ');

	SET @vSQL = CONCAT(@vSQL, ';');

	
	PREPARE smpt FROM @vSQL;
	EXECUTE smpt USING @vStartDate, @vEndDate;
	DEALLOCATE PREPARE smpt;
	



	SET vCurrent = vStartDate;
	WHILE vCurrent <= vEndDate DO

	
		IF(SELECT COUNT(cId) FROM tCrewProcess_temp WHERE DATE(cDate) = DATE(vCurrent)=0) THEN
			INSERT INTO tCrewProcess_temp(cDate, cEmployee, cHoursWorked, cWorked, cHired) VALUES(vCurrent, NULL, 0,FALSE,FALSE);

		END IF;
		SET vCurrent = DATE_ADD(vCurrent, INTERVAL 1 DAY);
	END WHILE;
	
	SET @vSQL = 'SELECT	cDate AS \'Fecha\', ROUND(SUM(cHoursWorked),2) AS \'Horas Trabajadas\', sum(if(cWorked, 1, 0)) AS \'Presente\', sum(if(cHired,1,0)) AS \'Contratados\', IFNULL( ROUND((sum(if(cWorked, 1, 0))*100)/sum(if(cHired,1,0)),2), 0) AS \'% Asistencia\' ';

	SET @vSQL = CONCAT(@vSQL, 'FROM	tCrewProcess_temp AS a ');
	SET @vSQL = CONCAT(@vSQL, 'WHERE cEmployee IN (', vEmployees,') OR cEmployee IS NULL ');
	SET @vSQL = CONCAT(@vSQL, 'GROUP BY DATE(cDate);');





	
	PREPARE smpt FROM @vSQL;
	EXECUTE smpt; 
	
	DEALLOCATE PREPARE smpt;
	
	DROP TABLE IF EXISTS tCrewProcess_temp;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pDeleteReport` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pDeleteReport`(IN vId BIGINT(20))
BEGIN
	DELETE FROM tReportProperty WHERE cReport=vId;
	DELETE FROM tReportParameter WHERE cReport=vId;
	DELETE FROM tReport WHERE cId=vId;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pDeleteUser` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pDeleteUser`(IN vId BIGINT(20))
BEGIN
	DELETE FROM tR_UserRol WHERE cUser=vId;
	DELETE FROM bsframework.tR_UserDomain WHERE cUser=vId;
	DELETE FROM bsframework.tUser WHERE cId=vId;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pExistsAttendanceLog` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pExistsAttendanceLog`(	IN vEmployeeKey VARCHAR(15), 
										IN vMachine BIGINT(20), 
										IN vMarkType BIGINT(20),
										IN vYear INTEGER,
										IN vMonth INTEGER,
										IN vDay INTEGER,
										IN vHour INTEGER,
										IN vMinute INTEGER,
										IN vSecond INTEGER)
BEGIN
	DECLARE vDate DATETIME;
	SET vDate = fToDateTime(vYear, vMonth, vDay, vHour, vMinute, vSecond);
	
	SELECT	count(cId) 
	FROM	tAttendanceLog 
	WHERE	cEmployeeKey=vEmployeeKey AND 
			cMachine=vMachine AND 
			cMarkType=vMarkType	AND 
			cDate=vDate;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pExistsLicense` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pExistsLicense`(IN vEmployeeId BIGINT(20), IN vLicenseCause BIGINT(20), IN vDocument VARCHAR(15), IN vStartDate DATE, IN vEndDate DATE)
BEGIN

	SELECT COUNT(cId) AS counter 
	FROM tLicense 
	WHERE cEmployee=vEmployeeId AND cLicenseCause=vLicenseCause AND cDocument=vDocument AND cStartDate=vStartDate AND cEndDate=vEndDate;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pGetEmployeeInfo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pGetEmployeeInfo`(IN vId BIGINT(20))
BEGIN
	SELECT	e.cId, e.cRut, e.cName, e.cPost, e.cArea, e.cPrivilege, 
			e.cUsername, a.cName AS cAreaName, a.cKey AS cCC,
			IFNULL((SELECT	t.cName
					FROM	tR_EmployeeTurn AS r
					LEFT JOIN tTurn AS t ON r.cTurn = t.cId
					WHERE	r.cEmployee = e.cId
					LIMIT 1
			), 'Diferido') AS cTurnName,
			IFNULL((	SELECT	CONCAT(t.cStartTime, ' - ', t.cEndTime) 
				FROM	tR_EmployeeTurn AS r
				LEFT JOIN tTurnDay AS t ON r.cTurn = t.cTurn
				WHERE	r.cEmployee = e.cId AND cDay = 1 
				LIMIT 1
			),'') AS cHorary
	FROM 	tEmployee AS e
	LEFT JOIN tArea AS a ON e.cArea = a.cId
	WHERE	e.cId = vId;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pHoursWorked` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pHoursWorked`(IN vStartDate DATE, IN vEndDate DATE)
BEGIN
	
	select * from tEmployee limit 10;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pListAttendance3` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pListAttendance3`(IN vEmployeeId VARCHAR(20), IN vStartDate DATE, IN vEndDate DATE)
BEGIN
	DECLARE vCurrent	DATE;
	DECLARE vStartTime	TIMESTAMP;
	DECLARE vStartMark	TIMESTAMP;
	DECLARE vStartDiffI	INTEGER;
	DECLARE vStartDiffM	VARCHAR(10);
	
	DECLARE vLunchMark	TIMESTAMP;
	DECLARE vReturnMark	TIMESTAMP;
	
	DECLARE vEndTime	TIMESTAMP;
	DECLARE vEndMark	TIMESTAMP;
	DECLARE vEndDiffI	INTEGER;
	DECLARE vEndDiffM	VARCHAR(10);
	
	DECLARE vComment	VARCHAR(120) DEFAULT '';
	DECLARE vMachine	BIGINT(20);
	
	
	DECLARE vTurnDayId		BIGINT(20);
	DECLARE vEmployeeKey	VARCHAR(25);
	DECLARE vRUT			VARCHAR(12);
	
	DECLARE vUpperLimit		DATETIME;
	DECLARE vLowerLimit		DATETIME;
	
	DECLARE vTolerance		INTEGER;
	DECLARE vBusinessDay	BOOLEAN DEFAULT FALSE;
	DECLARE vHoursWorkday	INTEGER;
	DECLARE vFlexible		BOOLEAN;
	
	SET vTolerance = fGetTolerance();
	SET vHoursWorkday = fGetHoursWorkday();
	
	DROP TEMPORARY TABLE IF EXISTS tAttendance_temp;
	CREATE TEMPORARY TABLE tAttendance_temp(
		cId			BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
		cDate		DATE NOT NULL,
		
		cStartTime	TIMESTAMP NULL,
		cStartMark	TIMESTAMP NULL,
		cStartDiffI	INTEGER,
		cStartDiffM	VARCHAR(10),
		
		cLunchMark	TIMESTAMP NULL,
		cReturnMark	TIMESTAMP NULL,
		
		cEndTime	TIMESTAMP NULL,
		cEndMark	TIMESTAMP NULL,
		cEndDiffI	INTEGER,
		cEndDiffM	VARCHAR(10),
		
		cComment	VARCHAR(120),
		cMachine	BIGINT(20)
    ) Engine=memory;
	
    SET vCurrent = vStartDate;
    SET vEndDate = DATE_ADD(vEndDate, INTERVAL 1 DAY);
    
	SELECT cKey, cRUT INTO vEmployeeKey, vRUT 
	FROM tEmployee 
	WHERE cId = vEmployeeId;
	
	WHILE vCurrent != vEndDate DO
		SET vFlexible = fIsFlexible(vCurrent, vEmployeeId);
		SET vComment = '';
		IF(vFlexible IS NULL) THEN
			SET vComment = fAppendComment(vComment, 'Sin turno');
			SET vStartTime = NULL;
			SET vStartMark = NULL;
			SET vStartDiffI = NULL;
			SET vStartDiffM = NULL;
			SET vLunchMark = NULL;
			SET vReturnMark = NULL;
			SET vEndTime = NULL;
			SET vEndMark = NULL;
			SET vEndDiffI = NULL;
			SET vEndDiffM = NULL;
			SET vMachine = NULL;
		ELSE
			IF(vFlexible) THEN
				SET vStartMark = fStartMark(vEmployeeKey, vTolerance, vCurrent, NULL, TRUE, NULL);
				

				
				SET vTurnDayId = fMarkAndUserToTurnDayId4(vStartMark, vEmployeeId, vTolerance, TRUE);
				


				SET vBusinessDay =  (SELECT cBusinessDay FROM tTurnDay WHERE cId = vTurnDayId);
			ELSE
				SET vTurnDayId = fMarkAndUserToTurnDayId4(vCurrent, vEmployeeId, vTolerance, FALSE);

				SET vBusinessDay =  (SELECT cBusinessDay FROM tTurnDay WHERE cId = vTurnDayId);
				SET vStartMark = fStartMark(vEmployeeKey, vTolerance, vCurrent, vBusinessDay, FALSE, vTurnDayId);
			END IF;
			
			SET vStartTime = fStartTime(vStartMark, vBusinessDay, vTurnDayId);
			SET vStartDiffI = fExtraTimeAsMins6(vStartMark, vStartTime, TRUE, vTurnDayId);

			SET vStartDiffM = fExtraTime3(vStartDiffI);
			SET vEndMark = fEndMark(vEmployeeKey, vStartMark, vHoursWorkday, vCurrent, vTolerance, vBusinessDay, vTurnDayId);
			SET vEndTime = fEndTime(vEndMark, vStartMark, vBusinessDay, vTurnDayId);

			SET vLunchMark = fLunchMark(vEmployeeKey, vStartMark, vHoursWorkday);
			
			SET vReturnMark = fReturnMark(vEmployeeKey, vStartMark, vHoursWorkday, vLunchMark);
			
			SET vEndDiffI = fExtraTimeAsMins6(vEndMark, vEndTime, FALSE, vTurnDayId);



			SET vEndDiffM = fExtraTime3(vEndDiffI);
			SET vMachine = (SELECT cMachine FROM tAttendanceLog WHERE cEmployeeKey = vEmployeeKey AND DATE(cDate) = DATE(vCurrent) AND cMarkType=1 LIMIT 1);
			SET vComment = fGetComment3(vCurrent, vEmployeeId, vTurnDayId, vBusinessDay, vStartMark, vEndMark);
			

	
			IF(NOT vBusinessDay) THEN
				SET vStartTime = NULL;
				SET vEndTime = NULL;
			END IF;
		
		END IF;
		
		INSERT INTO tAttendance_temp
				(cDate   , cStartTime, cStartMark, cStartDiffI, cStartDiffM, 
				cLunchMark, cReturnMark, 
				cEndTime, cEndMark, cEndDiffI, cEndDiffM,
				cMachine, cComment)
		VALUES	(vCurrent, vStartTime, vStartMark, vStartDiffI, vStartDiffM,			 
				vLunchMark, vReturnMark, 
				vEndTime, vEndMark, vEndDiffI, vEndDiffM,
				vMachine, vComment);

		SET vCurrent = DATE_ADD(vCurrent, INTERVAL 1 DAY);
	END WHILE;
	
	SELECT  cId, 
			vRUT AS cRUT,  
			cDate, 
			IFNULL(TIME(cStartTime),'') AS cStartTime, 
			IFNULL(TIME(cStartMark),'') AS cStartMark, 
			fStartDiffInSelect(cStartDiffI, cStartMark, cEndMark) AS cStartDiffI, 
			IFNULL(cStartDiffI, 0) AS cStartDiffI2, 
			IFNULL(cStartDiffM, '') AS cStartDiffM, 
			IFNULL(TIME(cLunchMark), '') AS cLunchMark, 
			IFNULL(TIME(cReturnMark), '') AS cReturnMark, 
			IFNULL(TIME(cEndTime), '') AS cEndTime, 
			IFNULL(TIME(cEndMark), '') AS cEndMark, 
			fEndDiffInSelect(cEndDiffI, cStartMark, cEndMark) AS cEndDiffI,
			IFNULL(cEndDiffI,0) AS cEndDiffI2, 
			IFNULL(cEndDiffM,'') AS cEndDiffM, 
			cComment, 
			IFNULL(cMachine,'') AS cMachine,
			fDayOfWeek3(cDate) AS cDayOfWeek 
	FROM tAttendance_temp;
	
	DROP TEMPORARY TABLE tAttendance_temp;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pListAttendance4` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pListAttendance4`(IN vEmployeeId BIGINT(20), IN vStartDate DATE, IN vEndDate DATE)
BEGIN
	DECLARE vCurrent	DATE;
	DECLARE vStartTime	TIMESTAMP;
	DECLARE vStartMark	TIMESTAMP;
	DECLARE vStartDiffI	INTEGER;
	DECLARE vStartDiffM	VARCHAR(10);
	
	DECLARE vLunchMark	TIMESTAMP;
	DECLARE vReturnMark	TIMESTAMP;
	
	DECLARE vEndTime	TIMESTAMP;
	DECLARE vEndMark	TIMESTAMP;
	DECLARE vEndDiffI	INTEGER;
	DECLARE vEndDiffM	VARCHAR(10);
	
	DECLARE vComment	VARCHAR(120) DEFAULT '';
	DECLARE vTurnDesc	VARCHAR(13) DEFAULT '';
	DECLARE vMachine	BIGINT(20);
	DECLARE	vTotal		DECIMAL(8,2) DEFAULT '0';
	
	
	DECLARE vTurnDayId		BIGINT(20);
	DECLARE vEmployeeKey	VARCHAR(25);
	DECLARE vRUT			VARCHAR(12);
	DECLARE vName			VARCHAR(50);
	
	DECLARE vUpperLimit		DATETIME;
	DECLARE vLowerLimit		DATETIME;
	
	DECLARE vTolerance		INTEGER;
	DECLARE vBusinessDay	BOOLEAN DEFAULT FALSE;
	DECLARE vHoursWorkday	INTEGER;
	DECLARE vFlexible		BOOLEAN;
	DECLARE vMaxRow			BIGINT;
	
	SET vTolerance = fGetTolerance();
	SET vHoursWorkday = fGetHoursWorkday();
	
	DROP TEMPORARY TABLE IF EXISTS tAttendance_temp;
	CREATE TEMPORARY TABLE tAttendance_temp(
		cId			BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
		cDate		DATE NOT NULL,
		
		cStartTime	TIMESTAMP NULL,
		cStartMark	TIMESTAMP NULL,
		cStartDiffI	INTEGER,
		cStartDiffM	VARCHAR(10),
		
		cLunchMark	TIMESTAMP NULL,
		cReturnMark	TIMESTAMP NULL,
		
		cEndTime	TIMESTAMP NULL,
		cEndMark	TIMESTAMP NULL,
		cEndDiffI	INTEGER,
		cEndDiffM	VARCHAR(10),
		
		cComment	VARCHAR(120),
		cTurnDesc	VARCHAR(13),
		

		
		cMachine	BIGINT(20)
    ) Engine=memory;
	
    SET vCurrent = vStartDate;
    SET vEndDate = DATE_ADD(vEndDate, INTERVAL 1 DAY);
    
	SELECT cKey, cRUT, cName INTO vEmployeeKey, vRUT, vName 
	FROM tEmployee 
	WHERE cId = vEmployeeId;
	
	WHILE vCurrent != vEndDate DO
		SET vFlexible = fIsFlexible(vCurrent, vEmployeeId);
		SET vComment = '';
		IF(vFlexible IS NULL) THEN
			SET vComment = fAppendComment(vComment, 'Sin turno');
			SET vStartTime = NULL;
			SET vStartMark = NULL;
			SET vStartDiffI = NULL;
			SET vStartDiffM = NULL;
			SET vLunchMark = NULL;
			SET vReturnMark = NULL;
			SET vEndTime = NULL;
			SET vEndMark = NULL;
			SET vEndDiffI = NULL;
			SET vEndDiffM = NULL;
			SET vMachine = NULL;
			SET vTurnDesc = NULL;

		ELSE
			IF(vFlexible) THEN
				SET vStartMark = fStartMark(vEmployeeKey, vTolerance, vCurrent, NULL, TRUE, NULL);

				SET vTurnDayId = fMarkAndUserToTurnDayId4(vStartMark, vEmployeeId, vTolerance, TRUE);
				SET vBusinessDay =  (SELECT cBusinessDay FROM tTurnDay WHERE cId = vTurnDayId);
			ELSE
				SET vTurnDayId = fMarkAndUserToTurnDayId4(vCurrent, vEmployeeId, vTolerance, FALSE);
				SET vBusinessDay =  (SELECT cBusinessDay FROM tTurnDay WHERE cId = vTurnDayId);

				SET vStartMark = fStartMark(vEmployeeKey, vTolerance, vCurrent, vBusinessDay, FALSE, vTurnDayId);
			END IF;
						
			SET vStartTime = fStartTime(vStartMark, vBusinessDay, vTurnDayId);
			SET vStartDiffI = fExtraTimeAsMins6(vStartMark, vStartTime, TRUE, vTurnDayId);
			SET vStartDiffM = fExtraTime3(vStartDiffI);
			SET vEndMark = fEndMark(vEmployeeKey, vStartMark, vHoursWorkday, vCurrent, vTolerance, vBusinessDay, vTurnDayId);
			

			
			SET vEndTime = fEndTime(vEndMark, vStartMark, vBusinessDay, vTurnDayId);

			SET vLunchMark = fLunchMark(vEmployeeKey, vStartMark, vHoursWorkday);
			
			SET vReturnMark = fReturnMark(vEmployeeKey, vStartMark, vHoursWorkday, vLunchMark);
			SET vEndDiffI = fExtraTimeAsMins6(vEndMark, vEndTime, FALSE, vTurnDayId);
			SET vEndDiffM = fExtraTime3(vEndDiffI);
			SET vMachine = (SELECT cMachine FROM tAttendanceLog WHERE cEmployeeKey = vEmployeeKey AND DATE(cDate) = DATE(vCurrent) AND cMarkType=1 LIMIT 1);
			SET vComment = fGetComment3(vCurrent, vEmployeeId, vTurnDayId, vBusinessDay, vStartMark, vEndMark);
			SET vTurnDesc = (SELECT CONCAT(cStartTime, ' A ', cEndTime) FROM tTurnDay WHERE cId = vTurnDayId);
 
			SET vTotal = vTotal + (IFNULL(vStartDiffI, 0) + IFNULL(vEndDiffI,0));
			
			IF(NOT vBusinessDay) THEN
				SET vStartTime = NULL;
				SET vEndTime = NULL;
			END IF;
		
		END IF;
		
		INSERT INTO tAttendance_temp
				(cDate   , cStartTime, cStartMark, cStartDiffI, cStartDiffM, 
				cLunchMark, cReturnMark, 
				cEndTime, cEndMark, cEndDiffI, cEndDiffM,
				cMachine, cComment, cTurnDesc)
		VALUES	(vCurrent, vStartTime, vStartMark, vStartDiffI, vStartDiffM,			 
				vLunchMark, vReturnMark, 
				vEndTime, vEndMark, vEndDiffI, vEndDiffM,
				vMachine, vComment, vTurnDesc);

		SET vCurrent = DATE_ADD(vCurrent, INTERVAL 1 DAY);
	END WHILE;
	



	SELECT MAX(cId)+1 INTO vMaxRow FROM tAttendance_temp;

	SELECT  cId							AS 'ITEM', 
			vRUT 						AS 'RUT', 
			UPPER(vName)				AS 'NOMBRE TRABAJADOR',
			fDayOfWeek3(cDate) 			AS 'DIA',
			DATE_FORMAT(cDate,'%d-%m-%Y')	AS 'FECHA',
			IFNULL(TIME(cStartMark),'') AS 'MARCA ENTRADA',
			IFNULL(cStartDiffM, '') 	AS 'EXTRA/ATRASO', 
			IFNULL(TIME(cEndMark), '')	AS 'MARCA SALIDA', 
			IFNULL(cEndDiffM,'')		AS 'COMPENSADO', 
			cComment					AS 'COMENTARIOS', 
			IFNULL(cTurnDesc,'')		AS 'TURNO'

	FROM tAttendance_temp
	UNION
	SELECT (vMaxRow) AS 'ITEM',
			'TOTAL HORAS' 						AS 'RUT', 
			''				AS 'NOMBRE TRABAJADOR',
			''				 			AS 'DIA',
			''						AS 'FECHA',
			'' AS 'MARCA ENTRADA',
			'' 	AS 'EXTRA/ATRASO', 
			''	AS 'MARCA SALIDA', 
			''		AS 'COMPENSADO', 
			CONCAT(fExtraTime3(ROUND(vTotal,0)), ' (',ROUND(vTotal/60,1),'hh)')	AS 'COMENTARIOS', 
			''		AS 'TURNO'
	ORDER BY ITEM;
	
	DROP TEMPORARY TABLE tAttendance_temp;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pListAttendanceAsExcel3` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pListAttendanceAsExcel3`(IN vStartDate DATE, IN vEndDate DATE)
BEGIN
	DECLARE vCurrent	DATE;
	DECLARE vStartTime	TIMESTAMP;
	DECLARE vStartMark	TIMESTAMP;
	DECLARE vStartDiffI	INTEGER;
	DECLARE vStartDiffM	VARCHAR(10);
	
	DECLARE vLunchMark	TIMESTAMP;
	DECLARE vReturnMark	TIMESTAMP;
	
	DECLARE vEndTime	TIMESTAMP;
	DECLARE vEndMark	TIMESTAMP;
	DECLARE vEndDiffI	INTEGER;
	DECLARE vEndDiffM	VARCHAR(10);
	
	DECLARE vComment	VARCHAR(120) DEFAULT '';
	DECLARE vMachine	BIGINT(20);
	
	DECLARE vTurnDayId	BIGINT(20);
	DECLARE vEmployeeId	BIGINT(20);
	DECLARE vEmployeeKey	VARCHAR(15);
	DECLARE vRUT		VARCHAR(12);


	
	
	DECLARE vName	VARCHAR(90);
	DECLARE vArea	VARCHAR(90);	
	DECLARE vCC		VARCHAR(10);
	DECLARE vTurn	VARCHAR(20);
	DECLARE vStart  VARCHAR(10);
	DECLARE vEnd	VARCHAR(10);
	

	DECLARE vTolerance		INTEGER;
	DECLARE vBusinessDay	BOOLEAN DEFAULT FALSE;
	DECLARE vHoursWorkday	INTEGER;
	DECLARE vFlexible		BOOLEAN;
	
declare a datetime;
declare b datetime;
	
	DECLARE vDone BOOLEAN DEFAULT FALSE;
	DECLARE cursorEmployee CURSOR FOR
		SELECT a.cId AS cId, a.cKey AS cKey, a.cRUT AS cRUT, a.cName AS cName, b.cName AS cArea, b.cKey AS cCC
		FROM tEmployee AS a
		LEFT JOIN tArea AS b on a.cArea = b.cId

		ORDER BY cId;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET vDone = TRUE;

	
set character_set_client=utf8;
set character_set_connection=utf8;
set character_set_database=utf8;
set character_set_results=utf8;
set character_set_server=utf8;


set a = now();

	
	SET vTolerance = fGetTolerance();
	SET vHoursWorkday = fGetHoursWorkday();
	
	
	DROP TABLE IF EXISTS tAttendance_temp;
	CREATE TEMPORARY TABLE tAttendance_temp (
		cId			BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
		cDate		DATE NOT NULL,
		
		cStartTime	TIMESTAMP NULL,
		cStartMark	TIMESTAMP NULL,
		cStartDiffI	INTEGER,
		cStartDiffM	VARCHAR(10),
		
		cLunchMark	TIMESTAMP NULL,
		cReturnMark	TIMESTAMP NULL,		
		
		cEndTime	TIMESTAMP NULL,
		cEndMark	TIMESTAMP NULL,
		cEndDiffI	INTEGER,
		cEndDiffM	VARCHAR(10),
		
		cComment	VARCHAR(120),
		cMachine	BIGINT(20),

		cRut		varchar(12),
		cName		varchar(90),
		cArea		VARCHAR(90),
		cCC			VARCHAR(10),
		cTurn		VARCHAR(20),
		cStart		VARCHAR(10),
		cEnd		VARCHAR(10)		
    ) ENGINE=innodb DEFAULT CHARSET=utf8;
	

    
    
    SET vEndDate = DATE_ADD(vEndDate, INTERVAL 1 DAY);
    
    OPEN cursorEmployee;
    cursorEmployee_loop: LOOP
    	FETCH cursorEmployee INTO vEmployeeId, vEmployeeKey, vRUT, vName, vArea, vCC;
    	
    	IF(vDone) THEN 
			LEAVE cursorEmployee_loop;
		END IF;
    	
	    SET vCurrent = vStartDate;
		WHILE vCurrent != vEndDate DO

			SET vFlexible = fIsFlexible(vCurrent, vEmployeeId);
			SET vComment = '';
			IF(vFlexible IS NULL) THEN
				SET vComment = fAppendComment(vComment, 'Sin turno');
				SET vStartTime = NULL;
				SET vStartMark = NULL;
				SET vStartDiffI = NULL;
				SET vStartDiffM = NULL;
				SET vLunchMark = NULL;
				SET vReturnMark = NULL;
				SET vEndTime = NULL;
				SET vEndMark = NULL;
				SET vEndDiffI = NULL;
				SET vEndDiffM = NULL;
				SET vMachine = NULL;
				
			ELSE
				IF(vFlexible) THEN
					SET vStartMark = fStartMark(vEmployeeKey, vTolerance, vCurrent, NULL, TRUE, NULL);
					SET vTurnDayId = fMarkAndUserToTurnDayId4(vStartMark, vEmployeeId, vTolerance, TRUE);
					SET vBusinessDay =  (SELECT cBusinessDay FROM tTurnDay WHERE cId = vTurnDayId);
				ELSE
					SET vTurnDayId = fMarkAndUserToTurnDayId4(vCurrent, vEmployeeId, vTolerance, FALSE);
					SET vBusinessDay =  (SELECT cBusinessDay FROM tTurnDay WHERE cId = vTurnDayId);
					SET vStartMark = fStartMark(vEmployeeKey, vTolerance, vCurrent, vBusinessDay, FALSE, vTurnDayId);
				END IF;

				SET vStartTime = fStartTime(vStartMark, vBusinessDay, vTurnDayId);	
				SET vStartDiffI = fExtraTimeAsMins5(vStartMark, vStartTime, TRUE);
				SET vStartDiffM = fExtraTime3(vStartDiffI);
				
				SET vEndMark = fEndMark(vEmployeeKey, vStartMark, vHoursWorkday, vCurrent, vTolerance, vBusinessDay, vTurnDayId);
				SET vEndTime = fEndTime(vEndMark, vStartMark, vBusinessDay, vTurnDayId);
				
				SET vLunchMark = fLunchMark(vEmployeeKey, vStartMark, vHoursWorkday);
				
				SET vReturnMark = fReturnMark(vEmployeeKey, vStartMark, vHoursWorkday, vLunchMark);
				SET vEndDiffI = fExtraTimeAsMins5(vEndMark, vEndTime, FALSE);
				SET vEndDiffM = fExtraTime3(vEndDiffI);
				SET vMachine = (SELECT cMachine FROM tAttendanceLog WHERE cEmployeeKey = vEmployeeKey AND DATE(cDate) = DATE(vCurrent) AND cMarkType=1 LIMIT 1);

				SET vComment = fGetComment3(vCurrent, vEmployeeId, vTurnDayId, vBusinessDay, vStartMark, vEndMark);
				
				
			
				IF(NOT vBusinessDay) THEN
					SET vStartTime = NULL;
					SET vEndTime = NULL;
				END IF;
				
				INSERT INTO tAttendance_temp
						(cDate   , cStartTime, cStartMark, cStartDiffI, cStartDiffM, 
						cLunchMark, cReturnMark, 
						cEndTime, cEndMark, cEndDiffI, cEndDiffM,
						cMachine, cComment, 
						cRut, cName, cArea, cCC, cTurn, cStart, cEnd)
				VALUES	(vCurrent, vStartTime, TIME(vStartMark), IFNULL(vStartDiffI, 0), vStartDiffM,			 
						vLunchMark, vReturnMark, 
						vEndTime, TIME(vEndMark), IFNULL(vEndDiffI,0), vEndDiffM,
						vMachine, vComment, 
						vRut, vName, vArea, vCC, vTurn, vStart, vEnd);
			END IF;
			SET vCurrent = DATE_ADD(vCurrent, INTERVAL 1 DAY);
		END WHILE;

	END LOOP cursorEmployee_loop;
	CLOSE cursorEmployee;
	
	SELECT
		cId					AS 'Item',
		cRut				AS 'RUT',
		cName				AS 'Nombre',
		cArea				AS 'Área',
		cCC					AS 'C.Costo',

		fDayOfWeek3(cDate)	AS 'Día',
		cDate				AS 'Fecha',
		TIME(cStartTime)	AS 'Entrada',
		TIME(cStartMark)	AS 'Marca Entrada',
		cStartDiffI			AS 'Extra/Atraso',
		cStartDiffM			AS 'Diferencia',
		
		TIME(cLunchMark)	AS 'Salida a Colación',
		TIME(cReturnMark)	AS 'Regreso de Colación',
		
		TIME(cEndTime)		AS 'Salida',
		TIME(cEndMark)		AS 'Marca Salida',
		cEndDiffI			AS 'Extra/Atraso',
		cEndDiffM			AS 'Diferencia',
		
		cComment			AS 'Comentarios',
		cMachine			AS 'Máquina',
		cTurn				AS 'Turno',
		TIME(cStartTime)	AS 'Entrada Turno',
		TIME(cEndTime)		AS 'Salida Turno'
	FROM tAttendance_temp;

	DROP TABLE IF EXISTS tAttendance_temp;
	
	set b = now();
	

	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pListBoss` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pListBoss`()
BEGIN
	SELECT	cId, cKey, cRut, cName, cPost, cArea, cPrivilege, cEnabled, cUsername 
	FROM 	tEmployee
	WHERE	cId IN (SELECT DISTINCT(cBoss) FROM tEmployee WHERE NOT cBoss IS NULL);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pListCorrectedTime` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pListCorrectedTime`(IN vEmployees VARCHAR(2500), IN vMonth INT, IN vYear INT)
BEGIN
	DECLARE vCommaPosition INTEGER DEFAULT 0;
	DECLARE vEmployee BIGINT(20);
	DECLARE vStart DATE;
	DECLARE vEnd DATE;
	
	SET vStart = DATE_FORMAT(CONCAT_WS('-', vYear, vMonth, '1'), '%Y-%m-%d');

	SET vEnd = LAST_DAY(vStart);
	
	WHILE (LENGTH(vEmployees)>0) DO
		SET vCommaPosition = INSTR(vEmployees, ',');
		
		IF(vCommaPosition=0) THEN
			SET vEmployee = CAST(vEmployees AS UNSIGNED);
			SET vEmployees = '';
		ELSE
			SET vEmployee = CAST(SUBSTR(vEmployees,1,vCommaPosition-1) AS UNSIGNED);
			SET vEmployees = RIGHT(vEmployees, LENGTH(vEmployees)-(LENGTH(vEmployee)+1));
		END IF;
		
		call pListAttendance4(vEmployee, vStart, vEnd);
	END WHILE;
		
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pListDetailReport` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pListDetailReport`(IN vBoss BIGINT(20), IN vEmployees VARCHAR(2000), IN vStartMonth INT, IN vStartYear INT, 
									IN vEndMonth INT, IN vEndYear INT)
BEGIN
	DECLARE vCommaPosition INTEGER DEFAULT 0;
	DECLARE vEmployee BIGINT(20);
	DECLARE vStart DATE;
	DECLARE vEnd DATE;
	

	
	SET vStart = DATE_FORMAT(CONCAT_WS('-', vStartYear, vStartMonth, '1'), '%Y-%m-%d');
	SET vEnd = DATE_FORMAT(CONCAT_WS('-', vEndYear, vEndMonth, '1'), '%Y-%m-%d');
	SET vEnd = LAST_DAY(vEnd);
	
	WHILE (LENGTH(vEmployees)>0) DO
		SET vCommaPosition = INSTR(vEmployees, ',');
		
		IF(vCommaPosition=0) THEN
			SET vEmployee = CAST(vEmployees AS UNSIGNED);
			SET vEmployees = '';
		ELSE
			SET vEmployee = CAST(SUBSTR(vEmployees,1,vCommaPosition-1) AS UNSIGNED);
			SET vEmployees = RIGHT(vEmployees, LENGTH(vEmployees)-(LENGTH(vEmployee)+1));
		END IF;
		

		call pListAttendance4(vEmployee, vStart, vEnd);
	END WHILE;
	



	
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pListEmployee` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pListEmployee`()
BEGIN
	SELECT	cId, cKey, cRut, cName, cPost, cArea, cPrivilege, cEnabled, cUsername 
	FROM 	tEmployee;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pListEventsByDates` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pListEventsByDates`(IN vStartDate DATE, IN vEndDate DATE)
BEGIN
	SELECT	a.cWhen AS cWhen, a.cUser AS cUser, b.cName AS cUserName, b.cMail AS cUserMail, a.cEventType AS cEventType, c.cName AS cEventTypeName, a.cWhat AS cWhat
	FROM	tEvent AS a
	LEFT JOIN bsframework.tUser AS b ON a.cUser = b.cId
	LEFT JOIN tEventType AS c ON a.cEventType = c.cId
	WHERE	DATE(cWhen) BETWEEN vStartDate AND vEndDate
	ORDER BY cWhen DESC;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pListEventsByDatesAndEventType` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pListEventsByDatesAndEventType`(IN vStartDate DATE, IN vEndDate DATE, IN vEventType BIGINT(20))
BEGIN
	SELECT	a.cWhen AS cWhen, a.cUser AS cUser, b.cName AS cUserName, b.cMail AS cUserMail, a.cEventType AS cEventType, c.cName AS cEventTypeName, a.cWhat AS cWhat
	FROM	tEvent AS a
	LEFT JOIN bsframework.tUser AS b ON a.cUser = b.cId
	LEFT JOIN tEventType AS c ON a.cEventType = c.cId
	WHERE	DATE(cWhen) BETWEEN vStartDate AND vEndDate
			AND c.cId = vEventType
	ORDER BY cWhen DESC;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pListEventsByDatesAndUser` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pListEventsByDatesAndUser`(IN vStartDate DATE, IN vEndDate DATE, IN vUserId BIGINT(20))
BEGIN
	SELECT	a.cWhen AS cWhen, a.cUser AS cUser, b.cName AS cUserName, b.cMail AS cUserMail, a.cEventType AS cEventType, c.cName AS cEventTypeName, a.cWhat AS cWhat
	FROM	tEvent AS a
	LEFT JOIN bsframework.tUser AS b ON a.cUser = b.cId
	LEFT JOIN tEventType AS c ON a.cEventType = c.cId
	WHERE	DATE(cWhen) BETWEEN vStartDate AND vEndDate
			AND b.cId = vUserId
	ORDER BY cWhen DESC;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pListEventsByDatesUserAndEventType` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pListEventsByDatesUserAndEventType`(IN vStartDate DATE, IN vEndDate DATE, IN vEventType BIGINT(20), IN vUserId BIGINT(20))
BEGIN
	SELECT	a.cWhen AS cWhen, a.cUser AS cUser, b.cName AS cUserName, b.cMail AS cUserMail, a.cEventType AS cEventType, c.cName AS cEventTypeName, a.cWhat AS cWhat
	FROM	tEvent AS a
	LEFT JOIN bsframework.tUser AS b ON a.cUser = b.cId
	LEFT JOIN tEventType AS c ON a.cEventType = c.cId
	WHERE	DATE(cWhen) BETWEEN vStartDate AND vEndDate
			AND c.cId = vEventType
			AND b.cId = vUserId
	ORDER BY cWhen DESC;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pListLater` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pListLater`(IN vStartDate DATE, IN vEndDate DATE)
BEGIN
	DECLARE vCurrent	DATE;
	DECLARE vStartTime	TIMESTAMP;
	DECLARE vStartMark	TIMESTAMP;
	DECLARE vStartDiffI	INTEGER;
	DECLARE vStartDiffM	VARCHAR(10);
	
	DECLARE vLunchMark	TIMESTAMP;
	DECLARE vReturnMark	TIMESTAMP;
	
	DECLARE vEndTime	TIMESTAMP;
	DECLARE vEndMark	TIMESTAMP;
	DECLARE vEndDiffI	INTEGER;
	DECLARE vEndDiffM	VARCHAR(10);
	
	DECLARE vComment	VARCHAR(120) DEFAULT '';
	DECLARE vMachine	BIGINT(20);
	
	DECLARE vTurnDayId	BIGINT(20);
	DECLARE vEmployeeId	BIGINT(20);
	DECLARE vEmployeeKey	VARCHAR(25);
	DECLARE vRUT		VARCHAR(12);
	DECLARE vMins		INTEGER;

	DECLARE vBusinessDay	BOOLEAN DEFAULT FALSE;
	DECLARE vTolerance		INTEGER;
	DECLARE vHoursWorkday	INTEGER;

	
	DECLARE vName	VARCHAR(90);
	DECLARE vArea	VARCHAR(90);	
	DECLARE vCC		VARCHAR(10);
	DECLARE vTurn	VARCHAR(20);
	DECLARE vStart  VARCHAR(10);
	DECLARE vEnd	VARCHAR(10);
	

	DECLARE vFlexible		BOOLEAN;
	
	DECLARE vDone BOOLEAN DEFAULT FALSE;
	DECLARE cursorEmployee CURSOR FOR
		SELECT a.cId AS cId, a.cKey AS cKey, a.cRUT AS cRUT, a.cName AS cName, b.cName AS cArea, b.cKey AS cCC
		FROM tEmployee AS a
		LEFT JOIN tArea AS b on a.cArea = b.cId;

	DECLARE CONTINUE HANDLER FOR NOT FOUND SET vDone = TRUE;
	
	SET vTolerance = fGetTolerance();
	SET vHoursWorkday = fGetHoursWorkday();
	
	DROP TEMPORARY TABLE IF EXISTS tAttendance_temp;
	CREATE TEMPORARY TABLE tAttendance_temp (
		cId			BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
		cDate		DATE NOT NULL,
		
		cStartTime	TIMESTAMP NULL,
		cStartMark	TIMESTAMP NULL,
		cStartDiffI	INTEGER,
		cStartDiffM	VARCHAR(10),
		
		cLunchMark	TIMESTAMP NULL,
		cReturnMark	TIMESTAMP NULL,		
		
		cEndTime	TIMESTAMP NULL,
		cEndMark	TIMESTAMP NULL,
		cEndDiffI	INTEGER,
		cEndDiffM	VARCHAR(10),
		
		cComment	VARCHAR(120),
		cMachine	BIGINT(20),

		cRut		varchar(12),
		cName		varchar(90),
		cArea		VARCHAR(90),
		cCC			VARCHAR(10),
		cTurn		VARCHAR(20),
		cStart		VARCHAR(10),
		cEnd		VARCHAR(10)		
    ) ENGINE=memory;
	
    SET vEndDate = DATE_ADD(vEndDate, INTERVAL 1 DAY);
    
    OPEN cursorEmployee;
    cursorEmployee_loop: LOOP
    	FETCH cursorEmployee INTO vEmployeeId, vEmployeeKey, vRUT, vName, vArea, vCC;
    	
    	IF(vDone) THEN 
			LEAVE cursorEmployee_loop;
		END IF;
    	
	    SET vCurrent = vStartDate;
		
		WHILE vCurrent != vEndDate DO
			SET vFlexible = fIsFlexible(vCurrent, vEmployeeId);
			SET vComment = '';
			IF(vFlexible IS NULL) THEN
				SET vComment = fAppendComment(vComment, 'Sin turno');			
			ELSE
				IF(vFlexible) THEN
					SET vStartMark = fStartMark(vEmployeeKey, vTolerance, vCurrent, NULL, TRUE, NULL);
					SET vTurnDayId = fMarkAndUserToTurnDayId4(vStartMark, vEmployeeId, vTolerance, TRUE);
					SET vBusinessDay =  (SELECT cBusinessDay FROM tTurnDay WHERE cId = vTurnDayId);
				ELSE
					SET vTurnDayId = fMarkAndUserToTurnDayId4(vCurrent, vEmployeeId, vTolerance, FALSE);
					SET vBusinessDay =  (SELECT cBusinessDay FROM tTurnDay WHERE cId = vTurnDayId);
					SET vStartMark = fStartMark(vEmployeeKey, vTolerance, vCurrent, vBusinessDay, FALSE, vTurnDayId);
				END IF;
		
				SET vStartTime = fStartTime(vStartMark, vBusinessDay, vTurnDayId);
				SET vStartDiffI = fExtraTimeAsMins6(vStartMark, vStartTime, TRUE, vTurnDayId);
				IF(vStartDiffI < 0) THEN
					SET vStartDiffM = fExtraTime3(vStartDiffI);
					SET vEndMark = fEndMark(vEmployeeKey, vStartMark, vHoursWorkday, vCurrent, vTolerance, vBusinessDay, vTurnDayId);
					SET vEndTime = fEndTime(vEndMark, vStartMark, vBusinessDay, vTurnDayId);
					
					SET vLunchMark = fLunchMark(vEmployeeKey, vStartMark, vHoursWorkday);
					
					SET vReturnMark = fReturnMark(vEmployeeKey, vStartMark, vHoursWorkday, vLunchMark);
					SET vEndDiffI = fExtraTimeAsMins6(vEndMark, vEndTime, FALSE, vTurnDayId);
					SET vEndDiffM = fExtraTime3(vEndDiffI);
					SET vMachine = (SELECT cMachine FROM tAttendanceLog WHERE cEmployeeKey = vEmployeeKey AND DATE(cDate) = DATE(vCurrent) AND cMarkType=1 LIMIT 1);
					SET vComment = fGetComment3(vCurrent, vEmployeeId, vTurnDayId, vBusinessDay, vStartMark, vEndMark);
			
					IF(NOT vBusinessDay) THEN
						SET vStartTime = NULL;
						SET vEndTime = NULL;
					END IF;
					
					INSERT INTO tAttendance_temp
							(cDate   , cStartTime, cStartMark, cStartDiffI, cStartDiffM, 
							cLunchMark, cReturnMark, 
							cEndTime, cEndMark, cEndDiffI, cEndDiffM,
							cMachine, cComment, 
							cRut, cName, cArea, cCC, cTurn, cStart, cEnd)
					VALUES	(vCurrent, vStartTime, TIME(vStartMark), IFNULL(vStartDiffI, 0), vStartDiffM,			 
							vLunchMark, vReturnMark, 
							vEndTime, TIME(vEndMark), IFNULL(vEndDiffI,0), vEndDiffM,
							vMachine, vComment, 
							vRut, vName, vArea, vCC, vTurn, vStart, vEnd);
				END IF;
				
			END IF;
			SET vCurrent = DATE_ADD(vCurrent, INTERVAL 1 DAY);
		END WHILE;

	END LOOP cursorEmployee_loop;
	CLOSE cursorEmployee;
	
	SELECT 
		cId														AS 'Item',
		cDate													AS 'Fecha',
		IFNULL(TIME(cStartTime),'')								AS 'Entrada',
		IFNULL(TIME(cStartMark),'')								AS 'Marca Entrada',
		fStartDiffInSelect(cStartDiffI, cStartMark, cEndMark)	AS 'Extra/Atraso',
		IFNULL(cStartDiffM, '')									AS 'Diferencia',

		IFNULL(TIME(cLunchMark), '')							AS 'Salida a Colación',
		IFNULL(TIME(cReturnMark), '')							AS 'Regreso de Colación',

		IFNULL(TIME(cEndTime), '')								AS 'Salida',
		IFNULL(TIME(cEndMark), '')								AS 'Marca Salida',

		fEndDiffInSelect(cEndDiffI, cStartMark, cEndMark)		AS 'Extra/Atraso',
		IFNULL(cEndDiffM,'')									AS 'Diferencia',

		cComment												AS 'Comentarios',
		IFNULL(cMachine,'')										AS 'Máquina',
		
		cRut													AS 'RUT',
		cName													AS 'Nombre',
		cArea													AS 'Área',
		cCC														AS 'C.Costo',
		IFNULL(cTurn,'')										AS 'Turno',
			
		fDayOfWeek3(cDate)										AS 'Día'
	FROM tAttendance_temp;
	
	DROP TABLE IF EXISTS tAttendance_temp;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pListMarkOfEmployee` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pListMarkOfEmployee`(IN vEmployeeId BIGINT(20), IN vStartDate DATE, 
									IN vEndDate DATE)
BEGIN
	SELECT	tAttendanceLog.cId					AS 'cId',
			tAttendanceLog.cMachine				AS 'cMachineId', 
			tMachine.cName						AS 'cMachineName', 
			tAttendanceLog.cDate				AS 'cDate',
			fDayOfWeek3(tAttendanceLog.cDate)	AS 'cWeekDay',
			tAttendanceLog.cMarkType			AS 'cMarkTypeId', 
			tMarkType.cName						AS 'cMarkTypeName',
			IF(tAttendanceModify.cId IS NULL,'','N')				
												AS 'cType'
	FROM 	tAttendanceLog
	LEFT JOIN tEmployee ON tAttendanceLog.cEmployeeKey = tEmployee.cKey
	LEFT JOIN tMachine ON tAttendanceLog.cMachine = tMachine.cId
	LEFT JOIN tMarkType ON tAttendanceLog.cMarkType = tMarkType.cId
	LEFT JOIN tAttendanceModify ON tAttendanceLog.cId = tAttendanceModify.cAttendanceLog
	WHERE	tEmployee.cId = vEmployeeId AND DATE(cDate) BETWEEN DATE(vStartDate) AND DATE(vEndDate)
	ORDER BY cDate DESC;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pListReportParameter` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pListReportParameter`(IN vReport BIGINT(20))
BEGIN
	SELECT 
		A.cId			AS cId,
		A.cReport		AS cReport,
		A.cName			AS cName,
		A.cLabel		AS cLabel,
		A.cOrder		AS cOrder,
		B.cId			AS cTypeId,
		B.cKey			AS cTypeKey,
		B.cName			AS cTypeName,
		B.cHTMLFile		AS cTypeHTMLFile, 
		B.cSource		AS cTypeSource,
		B.cJavaType		AS cJavaType
		
	FROM tReportParameter AS A 
	LEFT JOIN tReportParameterType AS B ON A.cType = B.cId
	WHERE cReport = vReport
	ORDER BY cOrder;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pListReportParams` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pListReportParams`(IN vIdReport BIGINT(20))
BEGIN	
	SELECT	cId
	FROM	tReportInParam
	WHERE	cReport = vIdReport
	ORDER BY cOrder;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pListReportPropertyByReportId` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pListReportPropertyByReportId`(IN vReportId BIGINT(20))
BEGIN
	DECLARE vType BIGINT(20);
	
	SELECT cType INTO vType FROM tReport WHERE cId = vReportId;
	
	SELECT 
		b.cId 			AS cPropertyId, 
		b.cPropertyType	AS cPropertyType, 
		b.cReport		AS cPropertyReport, 
		b.cValue		AS cPropertyValue,
		c.cId			AS cPropertyTypeId, 
		c.cKey			AS cPropertyTypeKey, 
		c.cName			AS PropertyTypeName
	FROM tR_ReportPropertyType_ReportType AS a
	LEFT JOIN tReportProperty AS b ON a.cReportPropertyType = b.cPropertyType AND b.cReport = vReportId
	LEFT JOIN tReportPropertyType AS c ON a.cReportPropertyType = c.cId 
	WHERE a.cReportType = vType;
	
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pListSummaryReport` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pListSummaryReport`(IN vBoss BIGINT(20), IN vEmployees VARCHAR(2000), IN vStartMonth INT, IN vStartYear INT, 
									IN vEndMonth INT, IN vEndYear INT)
BEGIN
	DECLARE vCurrent			DATE;
	DECLARE vLast				DATE;
	DECLARE vFirst				DATE;
	DECLARE vFirstMonth			DATE;
	DECLARE vLastMonth			DATE;
	DECLARE vBusinessDayCount	INTEGER DEFAULT 0;
	DECLARE vMarkCount			INTEGER DEFAULT 0;
	DECLARE vDelayCount			INTEGER DEFAULT 0;
	DECLARE vStartMarkCount		INTEGER DEFAULT 0;
	DECLARE vExtraTimeAM		INTEGER DEFAULT 0;
	DECLARE vExtraTimePM		INTEGER DEFAULT 0;
	DECLARE vI					INTEGER;
	DECLARE vJ					INTEGER;
	DECLARE vMax				INTEGER;
	DECLARE vEmployeeKey		VARCHAR(15);
	DECLARE vEmployeeId			BIGINT(20);
	DECLARE vFlexible			BOOLEAN;
	DECLARE vBusinessDay		BOOLEAN;
	DECLARE vTurnDayId			BIGINT(20);
	DECLARE vTolerance			INTEGER;
	DECLARE vHoursWorkday		INTEGER;
	DECLARE vHoliday			BOOLEAN;
	DECLARE vStartMark			DATETIME;
	DECLARE vEndMark			DATETIME;
	DECLARE vStartTime			DATETIME;
	DECLARE vEndTime			DATETIME;
	DECLARE vStartDiffI			INTEGER;
	DECLARE vEndDiffI			INTEGER;
	
	DECLARE vBothMarks			BIT;
	DECLARE vLicense			BIT;

	DROP TEMPORARY TABLE IF EXISTS tTemp;
	CREATE TEMPORARY TABLE tTemp (
		cId 				BIGINT(20) NOT NULL auto_increment,
		cStart				DATE  NOT NULL,
		cEnd				DATE  NOT NULL,
		cEmployeeKey		VARCHAR(15) NULL,
		cEmployeeId			BIGINT(20),
		cEmployeeRut		VARCHAR(11),
		cEmployeeName		VARCHAR(50),
		cBusinessDayCount	INTEGER DEFAULT 0,
		cMarkCount			INTEGER DEFAULT 0,
		cDelayCount			INTEGER DEFAULT 0,
		cStartMarkCount		INTEGER DEFAULT 0,
		cExtraTimeAM		INTEGER DEFAULT 0,
		cExtraTimePM		INTEGER DEFAULT 0,
		PRIMARY KEY (cId)
    ) Engine=memory;

	SET vFirst = DATE(CONCAT(vStartYear, '-', vStartMonth, '-01'));
	SET vCurrent = vFirst;
	SET vLast = LAST_DAY(DATE(CONCAT(vEndYear, '-', vEndMonth, '-01')));
	SET vTolerance = fGetTolerance();
	SET vHoursWorkday = fGetHoursWorkday();
	SET vBothMarks = fBothMarks();
	
    
	WHILE vCurrent <= vLast DO
		SET @vDynamicSQL = CONCAT('INSERT INTO tTemp(cStart, cEnd, cEmployeeKey, cEmployeeId, cEmployeeRut, cEmployeeName) SELECT ?, LAST_DAY(?), cKey, cId, cRut, cName FROM tEmployee WHERE cId IN (', vEmployees, ') ORDER BY cName;');

		SET @vCurrent = vCurrent;
		
		PREPARE smpt FROM @vDynamicSQL;
		EXECUTE smpt USING @vCurrent, @vCurrent;
		DEALLOCATE PREPARE smpt;

		SET vCurrent = DATE_ADD(vCurrent, INTERVAL 1 MONTH);
	END WHILE;

    
	SET vI = 1;
	SELECT MAX(cId) INTO vMax FROM tTemp;  
	WHILE (vI <= vMax) DO
		SELECT
			cEmployeeId, cEmployeeKey, cStart, cEnd INTO vEmployeeId, vEmployeeKey, vFirstMonth, vLastMonth
		FROM	tTemp
		WHERE	cId = vI;
		
		SET vBusinessDayCount := 0;
		SET vMarkCount := 0;
		SET vDelayCount := 0;
		SET vExtraTimeAM := 0;
		SET vExtraTimePM := 0;
		SET vCurrent = vFirstMonth;
		WHILE vCurrent <= vLastMonth DO
			SET vFlexible := fIsFlexible(vCurrent, vEmployeeId);
			IF(vFlexible IS NULL OR vFlexible = TRUE) THEN

			

				DELETE FROM tTemp WHERE cId = vI;
				SET vCurrent = vLastMonth;
			ELSE
				SET vTurnDayId := fMarkAndUserToTurnDayId4(vCurrent, vEmployeeId, vTolerance, FALSE);				
				SET vBusinessDay := fIsBusinessDay(vTurnDayId);
				SET vHoliday := fIsHoliday(vCurrent);
				SET vLicense := fHaveLicense(vCurrent, vEmployeeId);

				SET vStartMark = fStartMark(vEmployeeKey, vTolerance, vCurrent, vBusinessDay, FALSE, vTurnDayId);
				SET vStartTime = fStartTime(vStartMark, vBusinessDay, vTurnDayId);				
				SET vStartDiffI = fExtraTimeAsMins6(vStartMark, vStartTime, TRUE, vTurnDayId);
				

				
				SET vStartDiffI = IFNULL(vStartDiffI, 0);

				SET vEndMark = fEndMark(vEmployeeKey, vStartMark, vHoursWorkday, vCurrent, vTolerance, vBusinessDay, vTurnDayId);
				SET vEndTime = fEndTime(vEndMark, vStartMark, vBusinessDay, vTurnDayId);
				SET vEndDiffI = fExtraTimeAsMins6(vEndMark, vEndTime, FALSE, vTurnDayId);
				SET vEndDiffI = IFNULL(vEndDiffI, 0);
				
				IF(vBusinessDay AND NOT vHoliday AND NOT vLicense) THEN
					SET vBusinessDayCount = vBusinessDayCount + 1;
				END IF;
				
				IF(vBothMarks) THEN
					IF(NOT vStartMark IS NULL AND NOT vEndMark IS NULL) THEN 
						SET vMarkCount := vMarkCount + 1;
					END IF;
				ELSE
					IF(NOT vStartMark IS NULL OR NOT vEndMark IS NULL) THEN 
						SET vMarkCount := vMarkCount + 1;
					END IF;
				END IF;
				
				IF(NOT vStartMark IS NULL) THEN
					SET vStartMarkCount = vStartMarkCount + 1;
				END IF;
				
				IF(vStartDiffI <= -1 AND NOT vStartMark IS NULL) THEN
					SET vDelayCount := vDelayCount + 1;
				END IF;
				
				SET vExtraTimeAM := vExtraTimeAM + vStartDiffI;
				SET vExtraTimePM := vExtraTimePM + vEndDiffI;
				
			END IF;

			SET vCurrent = DATE_ADD(vCurrent, INTERVAL 1 DAY);
		END WHILE;
		
		UPDATE tTemp SET 
			cBusinessDayCount = vBusinessDayCount,
			cMarkCount = vMarkCount,
			cDelayCount = vDelayCount,
			cStartMarkCount = vStartMarkCount,
			cExtraTimeAM = vExtraTimeAM,
			cExtraTimePM = vExtraTimePM
		WHERE cId = vI;
		
		SET vI = vI + 1;
	END WHILE;
	
    
	SET vCurrent = DATE(CONCAT(vStartYear, '-', vStartMonth, '-01'));
	WHILE vCurrent <= vLast DO
		SELECT	cStart											AS 'Inicio', 
				cEnd											AS 'Termino',
				cEmployeeRut									AS 'Rut Empleado',
				cEmployeeName									AS 'Nombre Empleado',

				CONCAT(cMarkCount, '/', cBusinessDayCount)		AS 'Marcas realizadas',
				IFNULL(ROUND((cMarkCount*100)/cBusinessDayCount, 0),'Div x 0')	AS '% Asistencia',
				cDelayCount										AS 'Atrasos',
				ROUND((cDelayCount*100)/cStartMarkCount, 0)		AS '% Atrasos',
				cExtraTimeAM									AS 'Minutos Extras AM',
				cExtraTimePM									AS 'Minutos Extras PM',
				(cExtraTimeAM + cExtraTimePM)					AS 'Total Extra' 
		FROM tTemp 
		WHERE cStart = vCurrent;
		
		SET vCurrent = DATE_ADD(vCurrent, INTERVAL 1 MONTH);
	END WHILE;

	
	DROP TEMPORARY TABLE IF EXISTS tTemp;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pOvertime` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pOvertime`(IN vMonth INTEGER, IN vYear INTEGER, IN vArea BIGINT(20))
BEGIN
	
	
	CREATE TEMPORARY TABLE tOvertime_temp(
		cId			BIGINT NOT NULL AUTO_INCREMENT PRIMARY KEY,
		cEmployeeId	BIGINT(20) NOT NULL,
		
		cKey		VARCHAR(25),
		cRut		VARCHAR(11),
		cName		VARCHAR(50),
		
		cOvertimeI	INTEGER,
		cOvertimeM	VARCHAR(9)
    ) Engine=memory;
	
	INSERT	INTO tOvertime_temp(cEmployeeId, cKey, cRut, cName)
	SELECT	cId, cKey, cRut, cName
	FROM	tEmployee
	WHERE	cKey IN (SELECT DISTINCT(cEmployeeKey) 
					FROM tAttendanceLog 
					WHERE MONTH(cDate) = vMonth AND YEAR(cDate) = vYear) AND cArea = vArea;
					
	SELECT * FROM tAttendanceLog 
	WHERE MONTH(cDate) = vMonth AND YEAR(cDate) = vYear AND cEmployeeKey = '299';
					

	
	SELECT * FROM tOvertime_temp;
	DROP TEMPORARY TABLE tOvertime_temp;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pReadWeeksOfMonth` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pReadWeeksOfMonth`(IN vMonth INTEGER, IN vYear INTEGER)
BEGIN
	DECLARE vCurrent	DATE;
	DECLARE vLast		DATE;
	DECLARE vFirst		DATE;
	DECLARE vFirstLoop	BOOLEAN DEFAULT TRUE;
	DECLARE vMonday		DATE; 
	DECLARE vSunday		DATE; 
	
	SET vFirst = DATE(CONCAT(vYear, '-', vMonth, '-01'));
	SET vCurrent = vFirst;
	SET vLast = LAST_DAY(vFirst);
	
	DROP TEMPORARY TABLE IF EXISTS tWeek;
	CREATE TEMPORARY TABLE tWeek (
		cStart	DATE  NOT NULL,
		cEnd	DATE  NOT NULL
    ) Engine=memory;
	
	WHILE vCurrent <= vLast DO
		IF(vFirstLoop) THEN
			SET vMonday = vCurrent;
			SET vFirstLoop = FALSE;
		END IF;
	
		IF(DAYOFWEEK(vCurrent)=1) THEN 
			SET vSunday = vCurrent;
		ELSE
			IF(DAYOFWEEK(vCurrent)=2) THEN
				SET vMonday = vCurrent;
			END IF;
		END IF;
		
		IF(vCurrent = vLast) THEN
			SET vSunday = vCurrent;
		END IF;
		
		IF((IFNULL(vMonday, 0) != 0 AND IFNULL(vSunday, 0) != 0) OR vCurrent = vLast) THEN
			INSERT INTO tWeek(cStart, cEnd) VALUES(vMonday, vSunday);
			SET vMonday = NULL;
			SET vSunday = NULL;
		END IF;
		
		SET vCurrent = DATE_ADD(vCurrent, INTERVAL 1 DAY);
	END WHILE;

	SELECT cStart, cEnd FROM tWeek;
	
	DROP TEMPORARY TABLE IF EXISTS tWeek;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pSaveAttendanceLog` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pSaveAttendanceLog`(	IN vEmployeeKey VARCHAR(15), 
										IN vMachine BIGINT(20), 
										IN vMarkType BIGINT(20),
										IN vYear INTEGER,
										IN vMonth INTEGER,
										IN vDay INTEGER,
										IN vHour INTEGER,
										IN vMinute INTEGER,
										IN vSecond INTEGER)
BEGIN
	DECLARE vDate DATETIME;
	
	SET vDate = fToDateTime(vYear, vMonth, vDay, vHour, vMinute, vSecond);
	
	INSERT INTO tAttendanceLog(cEmployeeKey, cMachine, cMarkType, cDate)
	VALUES					  (vEmployeeKey, vMachine, vMarkType, vDate);
	
	SELECT LAST_INSERT_ID();
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pSaveAttendanceLog2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pSaveAttendanceLog2`(	IN vEmployeeKey VARCHAR(15), 
										IN vMachine BIGINT(20), 
										IN vMarkType BIGINT(20),
										IN vYear INTEGER,
										IN vMonth INTEGER,
										IN vDay INTEGER,
										IN vHour INTEGER,
										IN vMinute INTEGER,
										IN vSecond INTEGER)
BEGIN
	DECLARE vDate DATETIME;
	DECLARE vCount	INTEGER;
	
	SET vDate = fToDateTime(vYear, vMonth, vDay, vHour, vMinute, vSecond);
	
	SELECT	count(cId) INTO vCount 
	FROM	tAttendanceLog 
	WHERE	cEmployeeKey=vEmployeeKey AND 
			cMachine=vMachine AND 
			cMarkType=vMarkType	AND 
			cDate=vDate;
	
	IF(vCount=0) THEN
		INSERT INTO tAttendanceLog(cEmployeeKey, cMachine, cMarkType, cDate)
		VALUES					  (vEmployeeKey, vMachine, vMarkType, vDate);
		SELECT 1;
	ELSE
		SELECT 0;
	END IF;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pSaveReport` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pSaveReport`(IN vId BIGINT(20), IN vKey VARCHAR(20), IN vName VARCHAR(50), IN vType BIGINT(20))
BEGIN
	DECLARE vId BIGINT(20);
	INSERT INTO tReport(cKey, cName, cType) VALUES(vKey, vName, vType);
	
	SET vId = LAST_INSERT_ID();
	
	INSERT INTO tReportProperty(cPropertyType, cReport, cValue)
		SELECT c.cId, vId, '' 
			FROM tR_ReportPropertyType_ReportType AS a
			LEFT JOIN tReportProperty AS b ON a.cReportPropertyType = b.cPropertyType AND b.cReport = vId
			LEFT JOIN tReportPropertyType AS c ON a.cReportPropertyType = c.cId 
			WHERE a.cReportType = vType;


	
	SELECT vId;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pSplit` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pSplit`(IN str VARCHAR(50))
BEGIN
	DECLARE vEnd BOOLEAN DEFAULT FALSE;
	DECLARE vIndex INTEGER DEFAULT 0;
	DECLARE vPos INTEGER DEFAULT 0;
	DECLARE vValue VARCHAR(50) DEFAULT '';

	DROP TEMPORARY TABLE IF EXISTS tTempSplit;
	CREATE TEMPORARY TABLE tTempSplit (
		cId 				BIGINT(20) NOT NULL auto_increment,
		cValue				VARCHAR(50) NULL,
		PRIMARY KEY (cId)
    ) Engine=memory;

   	select vIndex, vPos, str;
    
    WHILE (NOT vEnd) DO
    	SET vPos = INSTR(str, ',');
    	SET vValue = SUBSTR(str, vIndex+1, vPos-1);
    	SET str = SUBSTR(str, vPos+1);
    	SET vIndex = vPos; 
    	
    	select vIndex, vPos, str;
    	
    	IF(LENGTH(str)=0 OR vPos = 0) THEN
    		SET vEnd = TRUE;
    	END IF;
    	
    	INSERT INTO tTempSplit(cValue) VALUES(vValue);
    	

    END WHILE;
    
	SELECT	cValue 
	FROM 	tTempSplit;
	DROP TEMPORARY TABLE IF EXISTS tTempSplit;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pSummary` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pSummary`(IN vStartDate DATE, IN vEndDate DATE, IN vEmployee VARCHAR(10), IN vTurn VARCHAR(10))
BEGIN
	IF(vEmployee = '') THEN
		SELECT * 
		FROM tTimeCtrl 
		WHERE cDate BETWEEN vStartDate AND vEndDate AND cTurn = vTurn;
	ELSE
		SELECT * 
		FROM tTimeCtrl 
		WHERE cDate BETWEEN vStartDate AND vEndDate AND cEmployeeKey = vEmployee AND cTurn = vTurn;
	END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pTest` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pTest`(IN vIds VARCHAR(50))
BEGIN
	SELECT	cid, cName 
	FROM 	tEmployee

	WHERE	pSplit(vIds) IN (cId);

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `pTopAbsence` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `pTopAbsence`(IN vStartDate DATE, IN vEndDate DATE, IN vTop INTEGER)
BEGIN
	DECLARE vId		BIGINT(20);
	DECLARE vKey 	VARCHAR(15);
	DECLARE vCurrent	DATE;
	DECLARE vCount	INTEGER;
	DECLARE vCountTemp	INTEGER;
	DECLARE vDone BOOLEAN DEFAULT FALSE;
	DECLARE cursorEmployee CURSOR FOR
		SELECT	cId, cKey
		FROM	tEmployee;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET vDone = TRUE;
	
	DROP TEMPORARY TABLE IF EXISTS tEmployee_temp;
	
	CREATE TEMPORARY TABLE tEmployee_temp (
		idEmployee		BIGINT(20)  NOT NULL,
		absenceCount	INTEGER DEFAULT '0'
    )Engine=memory;
	
	OPEN cursorEmployee;
	cursorEmployee_loop: LOOP
		FETCH cursorEmployee INTO vId, vKey;
		
		IF(vDone) THEN 
			LEAVE cursorEmployee_loop;
		END IF;
		
		SET vCount = 0;
		SET vCurrent = vStartDate;
		WHILE vCurrent <= vEndDate DO			
			IF NOT EXISTS(SELECT cId FROM tAttendanceLog WHERE DATE(vCurrent) = DATE(cDate) AND cEmployeeKey = vKey) AND fGetBusinessDay(vId, vKey, 180, vCurrent) THEN
				SET vCount = vCount + 1;
			END IF;

			SET vCurrent = DATE_ADD(vCurrent, INTERVAL 1 DAY);
		END WHILE;
				
	    INSERT INTO tEmployee_temp(idEmployee, absenceCount) 
	    	VALUES(vId, vCount);
		
		
	END LOOP cursorEmployee_loop;
	CLOSE cursorEmployee;
	
	SELECT b.cId			AS cId,
			b.cRut			AS cEmployeeRut,
			b.cName			AS cEmployeeName,
			c.cName			AS cEmployeePost,
			d.cName			AS cEmployeeArea,
			a.absenceCount	AS cAbsenceCount		
	FROM tEmployee_temp AS a
		LEFT JOIN tEmployee AS b ON a.idEmployee = b.cId
		LEFT JOIN tPost AS c ON b.cPost = c.cId
		LEFT JOIN tArea AS d ON b.cArea = d.cId
	ORDER BY absenceCount DESC 
	LIMIT vTop;

	DROP TEMPORARY TABLE IF EXISTS tEmployee_temp;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;

--
-- Final view structure for view `vuser`
--

/*!50001 DROP VIEW IF EXISTS `vuser`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `vuser` AS select `a`.`cId` AS `cId`,`a`.`cMail` AS `cMail`,`a`.`cName` AS `cName` from ((`bsframework`.`tuser` `a` left join `bsframework`.`tr_userdomain` `b` on((`a`.`cId` = `b`.`cUser`))) left join `bsframework`.`tdomain` `c` on((`b`.`cDomain` = `c`.`cId`))) where ((not(`a`.`cAdmin`)) and (`c`.`cDatabase` = database())) */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;
/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */;

/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;

-- Dump completed on 2016-02-19 23:11:38
